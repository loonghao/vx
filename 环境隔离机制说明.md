# vx 环境隔离机制说明

## ✅ 是的，vx 使用隔离环境

vx 采用了**多层次的隔离机制**，确保不同项目、不同版本的工具可以共存而不会冲突。

## 🏗️ 隔离架构

### 目录结构

```
~/.vx/  (或 ~/.local/share/vx/)
├── store/                      # 全局版本存储（内容寻址存储）
│   ├── node/
│   │   ├── 18.19.0/           # Node.js 18.19.0 完整安装
│   │   └── 20.10.0/           # Node.js 20.10.0 完整安装
│   ├── go/
│   │   ├── 1.20.0/
│   │   └── 1.21.5/
│   └── uv/
│       └── 0.1.24/
│
├── npm-tools/                  # npm 包工具（隔离环境）
│   └── vite/
│       └── 5.4.0/
│           ├── node_modules/  # 独立的 node_modules
│           └── bin/vite       # shim 脚本
│
├── pip-tools/                  # pip 包工具（隔离环境）
│   └── rez/
│       └── 2.114.0/
│           ├── venv/          # 独立的虚拟环境
│           └── bin/rez        # shim 脚本
│
├── envs/                       # 虚拟环境（链接到 store）
│   ├── default/               # 默认环境
│   │   └── node -> ../../store/node/20.10.0
│   └── project-abc/           # 项目特定环境
│       └── node -> ../../store/node/18.19.0
│
├── bin/                        # 全局 shims
├── cache/                      # 下载缓存
└── config/                     # 配置文件
```

## 🔒 隔离层次

### 1. 版本级隔离（Version-Level Isolation）

**每个工具的每个版本都有独立的安装目录**：

```bash
~/.vx/store/node/18.19.0/   # Node.js 18.19.0 的完整安装
~/.vx/store/node/20.10.0/   # Node.js 20.10.0 的完整安装
```

**特点**：
- ✅ 多个版本可以同时存在
- ✅ 版本之间完全隔离，互不影响
- ✅ 使用**内容寻址存储**（Content-Addressable Storage），相同版本只存储一份

**示例**：
```bash
# 项目 A 使用 Node.js 18
cd project-a
vx node --version  # 使用 18.19.0

# 项目 B 使用 Node.js 20
cd project-b
vx node --version  # 使用 20.10.0

# 两个版本同时存在，互不干扰
```

### 2. 环境隔离（Environment Isolation）

**通过虚拟环境实现项目间的隔离**：

```bash
~/.vx/envs/default/          # 默认环境
~/.vx/envs/project-a/        # 项目 A 的环境
~/.vx/envs/project-b/        # 项目 B 的环境
```

**工作原理**：
- 环境目录通过**符号链接**或**硬链接**指向 store 中的版本
- 不同环境可以链接到不同的版本
- 执行时根据项目配置选择对应的环境

**示例**：
```bash
# 项目 A 的 vx.toml
[tools]
node = "18"

# 项目 B 的 vx.toml
[tools]
node = "20"

# 在项目 A 中
cd project-a
vx node --version  # 自动使用 18.x

# 在项目 B 中
cd project-b
vx node --version  # 自动使用 20.x
```

### 3. 包工具隔离（Package Tool Isolation）

**npm 和 pip 工具也有独立的隔离环境**：

#### npm 工具隔离

```bash
~/.vx/npm-tools/vite/5.4.0/
├── node_modules/    # 独立的依赖
└── bin/vite         # 可执行文件
```

每个 npm 工具版本都有：
- ✅ 独立的 `node_modules` 目录
- ✅ 独立的可执行文件
- ✅ 不会与其他版本冲突

#### pip 工具隔离

```bash
~/.vx/pip-tools/rez/2.114.0/
├── venv/            # 独立的 Python 虚拟环境
└── bin/rez          # 可执行文件
```

每个 pip 工具版本都有：
- ✅ 独立的 Python 虚拟环境
- ✅ 独立的依赖包
- ✅ 完全隔离的运行时环境

## 🎯 隔离机制的工作原理

### 执行流程

当执行 `vx node --version` 时：

1. **版本解析**：
   - 检查是否有显式版本：`vx node@20`
   - 检查项目配置：`vx.toml`
   - 检查全局配置：`~/.config/vx/config.toml`
   - 使用默认版本

2. **路径查找**：
   - 在 `~/.vx/store/node/20.10.0/` 查找可执行文件
   - 如果不存在，自动安装

3. **环境激活**：
   - 设置 PATH 指向对应版本
   - 设置环境变量
   - 执行命令

4. **隔离保证**：
   - 每个版本在独立的目录中
   - PATH 只包含当前需要的版本
   - 不同项目使用不同的环境

### 链接策略

vx 使用智能链接策略来节省空间：

```rust
pub enum LinkStrategy {
    HardLink,      // 硬链接（同文件系统，最快）
    SymLink,       // 符号链接（跨文件系统）
    CopyOnWrite,   // 写时复制（支持 reflink）
    Copy,          // 复制（最后备选）
}
```

**优势**：
- 节省磁盘空间（多个环境共享同一版本）
- 快速创建新环境（链接而非复制）
- 跨平台支持（Windows/macOS/Linux）

## 📊 隔离对比

| 特性 | vx | 传统方式 |
|------|-----|---------|
| **版本隔离** | ✅ 每个版本独立目录 | ❌ 需要手动切换 |
| **项目隔离** | ✅ 自动根据配置选择 | ❌ 手动管理 |
| **包工具隔离** | ✅ npm/pip 工具独立环境 | ❌ 全局安装可能冲突 |
| **空间效率** | ✅ 链接共享，节省空间 | ⚠️ 可能重复安装 |
| **切换速度** | ✅ 即时切换 | ⚠️ 需要重新配置 |

## 🔍 实际示例

### 示例 1：多版本共存

```bash
# 安装多个 Node.js 版本
vx install node@18
vx install node@20

# 查看已安装版本
ls ~/.vx/store/node/
# 18.19.0/
# 20.10.0/

# 使用不同版本
vx node@18 --version  # v18.19.0
vx node@20 --version  # v20.10.0
```

### 示例 2：项目环境隔离

```bash
# 项目 A
cd ~/project-a
cat vx.toml
[tools]
node = "18"

vx node --version  # v18.19.0

# 项目 B
cd ~/project-b
cat vx.toml
[tools]
node = "20"

vx node --version  # v20.10.0

# 两个项目使用不同版本，完全隔离
```

### 示例 3：包工具隔离

```bash
# 安装 vite 的不同版本
vx npx vite@4 --version
vx npx vite@5 --version

# 每个版本都有独立的 node_modules
ls ~/.vx/npm-tools/vite/
# 4.5.0/
# 5.4.0/
```

## 🛡️ 隔离保证

### 1. 文件系统隔离

- ✅ 每个版本在独立目录
- ✅ 不会覆盖其他版本
- ✅ 可以同时安装多个版本

### 2. PATH 隔离

- ✅ 执行时只设置当前需要的版本到 PATH
- ✅ 不会影响系统 PATH
- ✅ 不同项目使用不同的 PATH

### 3. 环境变量隔离

- ✅ 每个环境可以设置不同的环境变量
- ✅ 通过 `vx.toml` 的 `[env]` 部分配置
- ✅ 不会影响系统环境变量

### 4. 依赖隔离

- ✅ npm 工具的依赖在独立的 `node_modules`
- ✅ pip 工具的依赖在独立的 `venv`
- ✅ 不会与其他版本冲突

## 📝 总结

**vx 的环境隔离机制**：

1. ✅ **版本级隔离**：每个版本独立目录
2. ✅ **环境隔离**：不同项目使用不同环境
3. ✅ **包工具隔离**：npm/pip 工具独立环境
4. ✅ **空间高效**：通过链接共享，节省空间
5. ✅ **自动管理**：根据项目配置自动选择版本

**关键点**：
- 隔离是**版本级别**的，不是容器级别的
- 通过**文件系统隔离**和**PATH 管理**实现
- 使用**链接策略**节省磁盘空间
- **自动切换**，无需手动管理

这使得 vx 可以安全地管理多个项目，每个项目使用不同的工具版本，而不会相互干扰。
