# MSVC Build Tools Provider Manifest
# This file defines the metadata, runtimes, and dependency constraints for MSVC.
#
# MSVC (Microsoft Visual C++) Build Tools provides:
# - cl.exe: C/C++ compiler
# - nmake: Program maintenance utility (Microsoft's make)
# - link.exe: Microsoft linker
#
# These tools are installed via Visual Studio Installer or Build Tools.

[provider]
name = "msvc"
description = "Microsoft Visual C++ Build Tools"
homepage = "https://visualstudio.microsoft.com/visual-cpp-build-tools/"
repository = "https://github.com/microsoft/STL"
ecosystem = "system"
license = "Proprietary"
license_note = "Microsoft Visual C++ Build Tools - free to use, proprietary license. vx only detects system installation"

# MSVC is Windows-only
[provider.platforms]
os = ["windows"]

# MSVC compiler
[[runtimes]]
name = "msvc"
description = "MSVC Build Tools"
executable = "cl"
aliases = ["cl", "vs-build-tools", "msvc-tools"]
auto_installable = true  # Uses msvc-kit for automatic installation

# RFC 0018: Detection configuration
# cl.exe outputs version info without arguments but returns exit code 2
[runtimes.detection]
command = "{executable}"
pattern = "Compiler Version ([\\d.]+)"
# cl.exe returns exit code 2 when run without source files
exit_codes = [0, 2]
# Visual Studio paths for cl.exe
system_paths = [
    "C:\\Program Files\\Microsoft Visual Studio\\2022\\Enterprise\\VC\\Tools\\MSVC\\*\\bin\\Hostx64\\x64\\cl.exe",
    "C:\\Program Files\\Microsoft Visual Studio\\2022\\Professional\\VC\\Tools\\MSVC\\*\\bin\\Hostx64\\x64\\cl.exe",
    "C:\\Program Files\\Microsoft Visual Studio\\2022\\Community\\VC\\Tools\\MSVC\\*\\bin\\Hostx64\\x64\\cl.exe",
    "C:\\Program Files\\Microsoft Visual Studio\\2022\\BuildTools\\VC\\Tools\\MSVC\\*\\bin\\Hostx64\\x64\\cl.exe",
    "C:\\Program Files (x86)\\Microsoft Visual Studio\\2022\\Enterprise\\VC\\Tools\\MSVC\\*\\bin\\Hostx64\\x64\\cl.exe",
    "C:\\Program Files (x86)\\Microsoft Visual Studio\\2022\\Professional\\VC\\Tools\\MSVC\\*\\bin\\Hostx64\\x64\\cl.exe",
    "C:\\Program Files (x86)\\Microsoft Visual Studio\\2022\\Community\\VC\\Tools\\MSVC\\*\\bin\\Hostx64\\x64\\cl.exe",
    "C:\\Program Files (x86)\\Microsoft Visual Studio\\2022\\BuildTools\\VC\\Tools\\MSVC\\*\\bin\\Hostx64\\x64\\cl.exe",
    "C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Enterprise\\VC\\Tools\\MSVC\\*\\bin\\Hostx64\\x64\\cl.exe",
    "C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\VC\\Tools\\MSVC\\*\\bin\\Hostx64\\x64\\cl.exe",
    "C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Community\\VC\\Tools\\MSVC\\*\\bin\\Hostx64\\x64\\cl.exe",
    "C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\BuildTools\\VC\\Tools\\MSVC\\*\\bin\\Hostx64\\x64\\cl.exe"
]

[runtimes.versions]
source = "vs-manifest"

[runtimes.platforms.windows]
executable_extensions = [".exe"]

# RFC 0021: System installation strategies
[runtimes.system_install]

# Windows: winget installation (recommended - official Microsoft package)
[[runtimes.system_install.strategies]]
type = "package_manager"
manager = "winget"
package = "Microsoft.VisualStudio.2022.BuildTools"
install_args = "--add Microsoft.VisualStudio.Workload.VCTools --includeRecommended --passive --wait"
platforms = ["windows"]
priority = 100

# Windows: chocolatey installation
[[runtimes.system_install.strategies]]
type = "package_manager"
manager = "choco"
package = "visualstudio2022buildtools"
params = "--add Microsoft.VisualStudio.Workload.VCTools --includeRecommended --passive --wait"
platforms = ["windows"]
priority = 80

# Fallback: Direct download of VS Build Tools installer
[[runtimes.system_install.strategies]]
type = "direct_download"
url = "https://aka.ms/vs/17/release/vs_buildtools.exe"
install_args = "--add Microsoft.VisualStudio.Workload.VCTools --includeRecommended --passive --wait"
platforms = ["windows"]
priority = 60

# Dependencies
[[runtimes.constraints]]
when = "*"
recommends = [
    { runtime = "cmake", version = "*", reason = "CMake is commonly used with MSVC for C++ projects" },
    { runtime = "ninja", version = "*", reason = "Ninja build system works well with MSVC" }
]

# nmake is bundled with MSVC
[[runtimes]]
name = "nmake"
description = "Microsoft Program Maintenance Utility"
executable = "nmake"
bundled_with = "msvc"
auto_installable = false

[runtimes.platforms.windows]
executable_extensions = [".exe"]

# link is bundled with MSVC
[[runtimes]]
name = "link"
description = "Microsoft Linker"
executable = "link"
bundled_with = "msvc"
auto_installable = false

[runtimes.platforms.windows]
executable_extensions = [".exe"]

# ml64 (MASM 64-bit assembler) is bundled with MSVC
[[runtimes]]
name = "ml64"
description = "Microsoft MASM 64-bit Assembler"
executable = "ml64"
bundled_with = "msvc"
auto_installable = false

[runtimes.platforms.windows]
executable_extensions = [".exe"]

# lib (library manager) is bundled with MSVC
[[runtimes]]
name = "lib"
description = "Microsoft Library Manager"
executable = "lib"
bundled_with = "msvc"
auto_installable = false

[runtimes.platforms.windows]
executable_extensions = [".exe"]
