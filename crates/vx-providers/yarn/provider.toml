# Yarn Provider Manifest
# This file defines the metadata, runtimes, and dependency constraints for Yarn.
# RFC 0017/0018 compliant - includes extended schema fields
#
# Yarn 1.x (Classic): Direct download from GitHub releases
# Yarn 2.x+ (Berry): Managed via corepack (bundled with Node.js 16.10+)

[provider]
name = "yarn"
description = "Fast, reliable, and secure dependency management"
homepage = "https://yarnpkg.com"
repository = "https://github.com/yarnpkg/yarn"
ecosystem = "nodejs"

[[runtimes]]
name = "yarn"
description = "Yarn package manager"
executable = "yarn"
aliases = ["yarnpkg"]
priority = 80
auto_installable = true
# RFC 0018: Mirror configuration
mirrors = [
    { name = "taobao", region = "cn", url = "https://npmmirror.com/mirrors/yarn", priority = 100 }
]

[runtimes.versions]
source = "github-releases"
owner = "yarnpkg"
repo = "yarn"
strip_v_prefix = true
lts_pattern = "1.22.*"

# RFC 0019: Executable Layout Configuration
[runtimes.layout]
download_type = "archive"

[runtimes.layout.archive]
strip_prefix = "yarn-v{version}"
executable_paths = [
    "bin/yarn.js",  # Yarn 1.x is a JS file
]

# RFC 0018: Detection configuration
[runtimes.detection]
command = "{executable} --version"
pattern = "(\\d+\\.\\d+\\.\\d+)"
env_hints = ["YARN_CACHE_FOLDER"]

# RFC 0018: Health check configuration
[runtimes.health]
check_command = "{executable} --version"
expected_pattern = "\\d+\\.\\d+\\.\\d+"
exit_code = 0
timeout_ms = 5000
check_on = ["install"]

# RFC 0018: Cache configuration
[runtimes.cache]
versions_ttl = 3600
cache_downloads = true
downloads_retention_days = 30

[runtimes.hooks]
pre_run = ["ensure_node_modules"]

[runtimes.platforms.windows]
executable_extensions = [".cmd", ".exe"]

[runtimes.platforms.unix]
executable_extensions = []

[runtimes.test]
timeout_ms = 30000
functional_commands = [
    { command = "{executable} --version", expect_success = true, expected_output = "\\d+\\.\\d+\\.\\d+", name = "version_check" },
]

# Yarn 1.x (Classic) requires Node.js 12-22
[[runtimes.constraints]]
when = "^1"
requires = [
    { runtime = "node", version = ">=12, <23", recommended = "20", reason = "Yarn 1.x requires Node.js 12-22 for native module compatibility" }
]

# Yarn 2.x-3.x (Berry) requires Node.js 16+ with corepack
[[runtimes.constraints]]
when = ">=2, <4"
requires = [
    { runtime = "node", version = ">=16.10", recommended = "20", reason = "Yarn 2.x-3.x requires Node.js 16.10+ with corepack" }
]

# Yarn 4.x requires Node.js 18+ with corepack
[[runtimes.constraints]]
when = ">=4"
requires = [
    { runtime = "node", version = ">=18", recommended = "22", reason = "Yarn 4.x requires Node.js 18+ with corepack" }
]
