# Node.js Provider Manifest
# This file defines the metadata, runtimes, and dependency constraints for Node.js.
# RFC 0017/0018 compliant - includes extended schema fields

[provider]
name = "node"
description = "JavaScript runtime built on Chrome's V8 engine"
homepage = "https://nodejs.org"
repository = "https://github.com/nodejs/node"
ecosystem = "nodejs"

# Node.js runtime
[[runtimes]]
name = "node"
description = "Node.js runtime"
executable = "node"
aliases = ["nodejs"]
priority = 100
auto_installable = true

# RFC 0018: Mirror configuration
mirrors = [
    { name = "taobao", region = "cn", url = "https://npmmirror.com/mirrors/node", priority = 100 },
    { name = "ustc", region = "cn", url = "https://mirrors.ustc.edu.cn/node", priority = 90 }
]

# RFC 0018: Environment configuration
[runtimes.env]
vars = { PATH = "{install_dir}/bin" }

[runtimes.env.advanced]
# PATH configuration (in order of priority)
path_prepend = ["{install_dir}/bin"]
# Isolation mode: don't inherit NODE_* variables from system environment
# Include SHELL, TERM, TMPDIR for npm postinstall scripts (they spawn shell processes)
inherit_system_vars = ["HOME", "USER", "SHELL", "TERM", "LANG", "LC_*", "TZ", "TMPDIR", "TEMP", "TMP"]

[runtimes.env.conditional]
"*" = { PATH = "{install_dir}/bin" }

[runtimes.versions]
source = "nodejs-org"
lts_pattern = "lts/*"

# RFC 0019: Executable Layout Configuration
[runtimes.layout]
download_type = "archive"

[runtimes.layout.archive]
strip_prefix = "node-v{version}-{platform}-{arch}"
executable_paths = [
    "bin/node.exe",  # Windows
    "bin/node"       # Unix
]

[runtimes.executable_config]
extensions = [".exe"]
dir_pattern = "node-v{version}-{platform}-{arch}"

[runtimes.platforms.windows]
executable_extensions = [".exe"]

[runtimes.platforms.unix]
executable_extensions = []

# RFC 0018: Detection configuration
[runtimes.detection]
command = "{executable} --version"
pattern = "v?(\\d+\\.\\d+\\.\\d+)"
system_paths = ["/usr/bin/node", "/usr/local/bin/node", "C:\\Program Files\\nodejs\\node.exe"]
env_hints = ["NODE_HOME", "NVM_DIR", "NODENV_ROOT"]

# RFC 0018: Health check configuration
[runtimes.health]
check_command = "{executable} -e \"console.log(process.version)\""
expected_pattern = "v\\d+\\.\\d+\\.\\d+"
exit_code = 0
timeout_ms = 5000
check_on = ["install", "activate"]

# RFC 0018: Cache configuration
[runtimes.cache]
versions_ttl = 3600
cache_downloads = true
downloads_retention_days = 30
shared_cache = true

# RFC 0020: Test configuration
[runtimes.test]
timeout_ms = 30000
functional_commands = [
    { command = "{executable} --version", expect_success = true, expected_output = "v\\d+\\.\\d+\\.\\d+", name = "version_check" },
    { command = "{executable} -e \"console.log('vx-test')\"", expect_success = true, expected_output = "vx-test", name = "eval_test" },
]
install_verification = [
    { command = "{executable} --version", expect_success = true },
]

[runtimes.test.platforms.windows]
functional_commands = [
    { command = "{executable} -e \"console.log(process.platform)\"", expect_success = true, expected_output = "win32", name = "platform_check" },
]

[runtimes.test.platforms.unix]
functional_commands = [
    { command = "{executable} -e \"console.log(process.platform)\"", expect_success = true, expected_output = "(linux|darwin)", name = "platform_check" },
]

# RFC 0018: Lifecycle hooks
[runtimes.hooks]
post_install = ["verify-node.sh"]
post_activate = ["setup-npm-config.sh"]

[runtimes.hooks.config]
fail_on_error = false
timeout_ms = 30000

# Node.js has no external dependencies
# But we can recommend npm as the default package manager
[[runtimes.constraints]]
when = "*"
recommends = [
    { runtime = "npm", version = "*", reason = "Default package manager bundled with Node.js" }
]

# NPM package manager (bundled with Node.js)
[[runtimes]]
name = "npm"
description = "Node Package Manager"
executable = "npm"
bundled_with = "node"

[runtimes.platforms.windows]
executable_extensions = [".cmd", ".exe"]

[runtimes.platforms.unix]
executable_extensions = []

[runtimes.test]
timeout_ms = 30000
functional_commands = [
    { command = "{executable} --version", expect_success = true, expected_output = "\\d+\\.\\d+\\.\\d+", name = "version_check" },
]

# npm 6.x requires Node.js 6-14
[[runtimes.constraints]]
when = "^6"
requires = [
    { runtime = "node", version = ">=6, <15", recommended = "14", reason = "npm 6.x is designed for Node.js 6-14" }
]

# npm 7.x-8.x requires Node.js 12+
[[runtimes.constraints]]
when = ">=7, <9"
requires = [
    { runtime = "node", version = ">=12", recommended = "18", reason = "npm 7.x-8.x requires Node.js 12+" }
]

# npm 9.x+ requires Node.js 14+
[[runtimes.constraints]]
when = ">=9"
requires = [
    { runtime = "node", version = ">=14", recommended = "20", reason = "npm 9.x+ requires Node.js 14+" }
]

# NPX package runner (bundled with Node.js)
[[runtimes]]
name = "npx"
description = "Node Package Execute"
executable = "npx"
bundled_with = "node"

[runtimes.platforms.windows]
executable_extensions = [".cmd", ".exe"]

[runtimes.platforms.unix]
executable_extensions = []

[runtimes.test]
timeout_ms = 30000
functional_commands = [
    { command = "{executable} --version", expect_success = true, expected_output = "\\d+\\.\\d+\\.\\d+", name = "version_check" },
]

# npx requires Node.js 12+ (comes with npm 5.2+)
[[runtimes.constraints]]
when = "*"
requires = [
    { runtime = "node", version = ">=12", recommended = "20", reason = "npx requires Node.js 12+" }
]
