# ImageMagick Provider Manifest
# This file defines the metadata, runtimes, and dependency constraints for ImageMagick.
#
# ImageMagick is a powerful image manipulation software suite.
# - Linux: Uses AppImage binary from imagemagick.org (direct download)
# - macOS: Requires Homebrew (vx-managed brew runtime)
# - Windows: Prefers winget (built-in on Win11), falls back to choco/scoop
#
# Installation flow:
# 1. Resolver detects platform-specific dependencies (brew on macOS, winget/choco/scoop on Windows)
# 2. Resolver ensures package managers are installed first
# 3. ImageMagick is installed via the appropriate package manager
#
# This is a "version-insensitive" tool - users just need "any working version"

[provider]
name = "imagemagick"
description = "ImageMagick - A powerful image manipulation and conversion tool"
homepage = "https://imagemagick.org/"
repository = "https://github.com/ImageMagick/ImageMagick"
ecosystem = "system"

# Main magick runtime (unified CLI since ImageMagick 7)
[[runtimes]]
name = "magick"
description = "ImageMagick unified command-line tool"
executable = "magick"
aliases = ["imagemagick"]

[runtimes.versions]
source = "github-releases"
owner = "ImageMagick"
repo = "ImageMagick"
strip_v_prefix = false

# Layout configuration for binary download (Linux AppImage)
[runtimes.layout]
download_type = "binary"

[runtimes.layout.binary."linux-x86_64"]
source_name = "magick"
target_name = "magick"
target_dir = "bin"
target_permissions = "755"

[runtimes.platforms.windows]
executable_extensions = [".exe"]

[runtimes.platforms.unix]
executable_extensions = []

# RFC 0021: System-level dependencies
# These are resolved by vx-resolver BEFORE installation attempts
[runtimes.system_deps]

# macOS requires Homebrew to be available
[[runtimes.system_deps.pre_depends]]
type = "runtime"
id = "brew"
platforms = ["macos"]
reason = "Required to install ImageMagick on macOS (no portable binary available)"
optional = false

# Windows: winget (preferred, built-in on Win11), choco, or scoop
# winget is preferred as it's built-in on Windows 11 and available on Windows 10 via App Installer
[[runtimes.system_deps.pre_depends]]
type = "runtime"
id = "winget"
platforms = ["windows"]
reason = "Preferred package manager for Windows (built-in on Windows 11)"
optional = true

[[runtimes.system_deps.pre_depends]]
type = "runtime"
id = "choco"
platforms = ["windows"]
reason = "Alternative to winget for Windows installation"
optional = true

[[runtimes.system_deps.pre_depends]]
type = "runtime"
id = "scoop"
platforms = ["windows"]
reason = "Alternative to winget for Windows installation"
optional = true

# System installation strategies for platforms where binary download is not available
[[runtimes.system_install.strategies]]
type = "package_manager"
manager = "brew"
package = "imagemagick"
platforms = ["macos"]
priority = 90

# winget has highest priority on Windows (built-in on Win11)
[[runtimes.system_install.strategies]]
type = "package_manager"
manager = "winget"
package = "ImageMagick.ImageMagick"
platforms = ["windows"]
priority = 95

[[runtimes.system_install.strategies]]
type = "package_manager"
manager = "choco"
package = "imagemagick"
platforms = ["windows"]
priority = 80

[[runtimes.system_install.strategies]]
type = "package_manager"
manager = "scoop"
package = "imagemagick"
platforms = ["windows"]
priority = 60

[[runtimes.system_install.strategies]]
type = "package_manager"
manager = "apt"
package = "imagemagick"
platforms = ["linux"]
priority = 80

[[runtimes.system_install.strategies]]
type = "package_manager"
manager = "dnf"
package = "ImageMagick"
platforms = ["linux"]
priority = 80

# No vx-runtime dependencies (different from system_deps)
[[runtimes.constraints]]
when = "*"
recommends = []

# Legacy convert command (symlink/alias to magick)
[[runtimes]]
name = "convert"
description = "ImageMagick convert tool (legacy, use 'magick' instead)"
executable = "convert"
bundled_with = "magick"

[[runtimes.constraints]]
when = "*"
requires = [
    { runtime = "magick", version = "*", reason = "convert is part of ImageMagick" }
]
