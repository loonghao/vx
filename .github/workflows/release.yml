# cargo-dist release workflow
# This workflow handles the complete release process using cargo-dist:
# 1. Build binaries for all platforms (Linux, macOS, Windows)
# 2. Generate installers (shell, powershell, homebrew)
# 3. Create GitHub releases with checksums
#
# Triggered by:
# - Push to main: runs release-please to create release PRs
# - Tag push (v*): builds and publishes release artifacts
# - Manual trigger: rebuild for a specific tag
#
# Based on: https://opensource.axo.dev/cargo-dist/

name: Release

on:
  push:
    branches:
      - main
    tags:
      - 'v[0-9]+.*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to build (e.g., v0.6.27). Leave empty for latest.'
        required: false
        type: string
        default: ''

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write
  attestations: write
  actions: read

env:
  CARGO_TERM_COLOR: always

# Cancel in-progress runs for the same ref
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Run release-please on main branch pushes
  release-please:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

  # Determine build configuration
  plan:
    name: Plan release
    runs-on: ubuntu-latest
    needs: [release-please]
    if: |
      always() &&
      (
        (needs.release-please.result == 'success' && needs.release-please.outputs.release_created == 'true') ||
        (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) ||
        github.event_name == 'workflow_dispatch'
      )
    outputs:
      tag: ${{ steps.plan.outputs.tag }}
      version: ${{ steps.plan.outputs.version }}
      targets: ${{ steps.plan.outputs.targets }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine tag and version
        id: plan
        shell: bash
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ inputs.tag }}" ]; then
            TAG="${{ inputs.tag }}"
          elif [ "${{ needs.release-please.outputs.tag_name }}" != "" ]; then
            TAG="${{ needs.release-please.outputs.tag_name }}"
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            TAG="${{ github.ref_name }}"
          else
            TAG=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r .tag_name)
          fi
          
          if [ -z "$TAG" ] || [ "$TAG" == "null" ]; then
            echo "::error::Could not determine tag"
            exit 1
          fi
          
          VERSION="${TAG#v}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Building tag: ${TAG}, version: ${VERSION}"
          
          # Define build matrix as JSON
          echo 'targets=["x86_64-unknown-linux-gnu","x86_64-unknown-linux-musl","aarch64-unknown-linux-gnu","aarch64-unknown-linux-musl","x86_64-apple-darwin","aarch64-apple-darwin","x86_64-pc-windows-msvc","aarch64-pc-windows-msvc"]' >> $GITHUB_OUTPUT

  # Build binaries for each platform
  build:
    name: Build (${{ matrix.target }})
    needs: [plan]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux GNU
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-22.04
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-22.04
          # Linux musl
          - target: x86_64-unknown-linux-musl
            os: ubuntu-22.04
          - target: aarch64-unknown-linux-musl
            os: ubuntu-22.04
          # macOS
          - target: x86_64-apple-darwin
            os: macos-13
          - target: aarch64-apple-darwin
            os: macos-14
          # Windows
          - target: x86_64-pc-windows-msvc
            os: windows-latest
          - target: aarch64-pc-windows-msvc
            os: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.plan.outputs.tag }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      # Install cross-compilation dependencies
      - name: Install Linux cross-compilation tools
        if: runner.os == 'Linux' && contains(matrix.target, 'aarch64')
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

      - name: Install musl tools
        if: contains(matrix.target, 'musl')
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools
          if [[ "${{ matrix.target }}" == "aarch64"* ]]; then
            # For aarch64-musl, we need cross compiler
            sudo apt-get install -y musl-dev
            wget -q https://musl.cc/aarch64-linux-musl-cross.tgz
            tar -xzf aarch64-linux-musl-cross.tgz
            echo "$PWD/aarch64-linux-musl-cross/bin" >> $GITHUB_PATH
          fi

      # Build using cross for Linux targets
      - name: Build (Linux cross)
        if: runner.os == 'Linux'
        uses: houseabsolute/actions-rust-cross@v1
        with:
          command: build
          target: ${{ matrix.target }}
          args: "--release --bin vx --features cdn-acceleration"
          strip: true

      # Build natively for macOS and Windows
      - name: Build (native)
        if: runner.os != 'Linux'
        shell: bash
        run: |
          cargo build --release --target ${{ matrix.target }} --bin vx --features cdn-acceleration
          if [[ "${{ runner.os }}" == "macOS" ]]; then
            strip target/${{ matrix.target }}/release/vx
          fi

      # Create archives
      - name: Create archive (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          VERSION="${{ needs.plan.outputs.version }}"

          # Cross-platform sha256 function (macOS uses shasum, Linux uses sha256sum)
          sha256() {
            if command -v sha256sum &>/dev/null; then
              sha256sum "$1" > "$1.sha256"
            else
              shasum -a 256 "$1" > "$1.sha256"
            fi
          }

          cd target/${{ matrix.target }}/release

          # Versioned archive
          tar -czvf ../../../vx-${VERSION}-${{ matrix.target }}.tar.gz vx
          cd ../../..
          sha256 "vx-${VERSION}-${{ matrix.target }}.tar.gz"

          # Backward-compatible archive (without version)
          cp vx-${VERSION}-${{ matrix.target }}.tar.gz vx-${{ matrix.target }}.tar.gz
          sha256 "vx-${{ matrix.target }}.tar.gz"

      - name: Create archive (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $VERSION = "${{ needs.plan.outputs.version }}"
          cd target/${{ matrix.target }}/release
          
          # Versioned archive
          Compress-Archive -Path vx.exe -DestinationPath ../../../vx-${VERSION}-${{ matrix.target }}.zip
          cd ../../..
          $hash = (Get-FileHash vx-${VERSION}-${{ matrix.target }}.zip -Algorithm SHA256).Hash.ToLower()
          "$hash  vx-${VERSION}-${{ matrix.target }}.zip" | Out-File -Encoding ASCII vx-${VERSION}-${{ matrix.target }}.zip.sha256
          
          # Backward-compatible archive
          Copy-Item vx-${VERSION}-${{ matrix.target }}.zip vx-${{ matrix.target }}.zip
          $hashCompat = (Get-FileHash vx-${{ matrix.target }}.zip -Algorithm SHA256).Hash.ToLower()
          "$hashCompat  vx-${{ matrix.target }}.zip" | Out-File -Encoding ASCII vx-${{ matrix.target }}.zip.sha256

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ matrix.target }}
          path: |
            vx-*.tar.gz
            vx-*.tar.gz.sha256
            vx-*.zip
            vx-*.zip.sha256
          if-no-files-found: error

  # Publish release artifacts
  publish:
    name: Publish release
    needs: [plan, build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.plan.outputs.tag }}

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: dist-*
          merge-multiple: true

      - name: List artifacts
        run: |
          echo "ðŸ“¦ Release artifacts:"
          ls -la artifacts/
          echo ""
          echo "ðŸ“‹ Checksums:"
          cat artifacts/*.sha256

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.plan.outputs.tag }}
          files: artifacts/*
          fail_on_unmatched_files: true
          generate_release_notes: false
          append_body: true
          body: |
            
            ---
            
            ### Installation
            
            #### Quick Install (Recommended)
            
            **Linux/macOS:**
            ```bash
            curl -fsSL https://raw.githubusercontent.com/loonghao/vx/main/install.sh | bash
            ```
            
            **Windows (PowerShell):**
            ```powershell
            irm https://raw.githubusercontent.com/loonghao/vx/main/install.ps1 | iex
            ```
            
            #### Static Binary (musl, no runtime dependencies)
            
            ```bash
            PREFER_STATIC=true curl -fsSL https://raw.githubusercontent.com/loonghao/vx/main/install.sh | bash
            ```
            
            #### Package Managers
            
            - **Homebrew:** `brew install loonghao/vx/vx`
            - **Cargo:** `cargo install vx`
            
            #### Manual Download
            
            Download the appropriate binary for your platform from the assets above.

  # Generate attestations
  attest:
    name: Generate attestations
    needs: [plan, publish]
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: dist-*
          merge-multiple: true

      - name: Generate attestations
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: artifacts/*
