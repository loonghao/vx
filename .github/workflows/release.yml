name: Release Please

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - '.github/workflows/release.yml'
      - 'release-please-config.json'
      - '.release-please-manifest.json'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write
  repository-projects: write
  actions: read

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
      pr: ${{ steps.release.outputs.pr }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check commit message
        run: |
          echo "Commit message: ${{ github.event.head_commit.message }}"
          echo "Commit author: ${{ github.event.head_commit.author.name }}"
          echo "Should skip: ${{ contains(github.event.head_commit.message, 'chore(main): release') }}"

      - name: Run release-please
        id: release
        uses: googleapis/release-please-action@v4
        with:
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Debug release-please outputs
        run: |
          echo "Release created: ${{ steps.release.outputs.release_created }}"
          echo "Tag name: ${{ steps.release.outputs.tag_name }}"
          echo "Version: ${{ steps.release.outputs.version }}"
          echo "PR: ${{ steps.release.outputs.pr }}"

          RELEASE_CREATED="${{ steps.release.outputs.release_created }}"
          TAG_NAME="${{ steps.release.outputs.tag_name }}"
          VERSION="${{ steps.release.outputs.version }}"
          PR_URL="${{ steps.release.outputs.pr }}"

          if [ "$RELEASE_CREATED" = "true" ]; then
            echo "Release created! Tag: $TAG_NAME"
            echo "The tag-release.yml workflow will handle the actual release process."
          elif [ -n "$PR_URL" ]; then
            echo "Release PR created: $PR_URL"
            echo "Merge the PR to trigger the release."
          else
            echo "No release or PR created. Waiting for more commits."
          fi
