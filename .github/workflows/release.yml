name: Release

# This workflow runs on main branch pushes and handles the complete release process:
# 1. Regular commits to main: Runs release-please to check if a release PR should be created/updated
# 2. release-please PR merge: Creates a release, builds binaries, and publishes to crates.io
# 3. Manual trigger: Rebuild binaries for a specific tag (useful when build failed)
#
# Note: release-please creates tags in format "v0.4.1" (v format)

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to rebuild (e.g., v0.4.1). Leave empty to use latest release.'
        required: false
        type: string
        default: ''
      skip-crates-publish:
        description: 'Skip publishing to crates.io'
        required: false
        type: boolean
        default: true

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write
  attestations: write
  actions: read

env:
  CARGO_TERM_COLOR: always

jobs:
  # First job: Run release-please to create releases and tags
  # This only runs on main branch pushes (not tag pushes or manual triggers)
  release-please:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      releases_created: ${{ steps.release.outputs.releases_created }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

  # Get the tag to build (from release-please or manual input)
  get-tag:
    runs-on: ubuntu-latest
    needs: [release-please]
    if: |
      always() &&
      (
        (needs.release-please.result == 'success' && needs.release-please.outputs.release_created == 'true') ||
        github.event_name == 'workflow_dispatch'
      )
    outputs:
      tag_name: ${{ steps.get-tag.outputs.tag_name }}
      version: ${{ steps.get-tag.outputs.version }}
    steps:
      - name: Get tag name
        id: get-tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            if [ -n "${{ inputs.tag }}" ]; then
              TAG="${{ inputs.tag }}"
            else
              # Get latest release tag
              TAG=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r .tag_name)
            fi
          else
            TAG="${{ needs.release-please.outputs.tag_name }}"
          fi
          echo "tag_name=${TAG}" >> $GITHUB_OUTPUT
          # Extract version number: vx-v0.5.0 -> 0.5.0, v0.5.0 -> 0.5.0
          VERSION=$(echo "${TAG}" | sed -E 's/^(vx-)?v//')
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building for tag: ${TAG}, version: ${VERSION}"

  # Build CLI binaries for all platforms
  build-binaries:
    name: Build (${{ matrix.platform.os_name }})
    needs: [get-tag]
    if: needs.get-tag.result == 'success' && needs.get-tag.outputs.tag_name != ''
    runs-on: ${{ matrix.platform.os }}
    strategy:
      fail-fast: false
      matrix:
        platform:
          # Linux platforms
          - os_name: Linux-x86_64
            os: ubuntu-latest
            target: x86_64-unknown-linux-gnu

          - os_name: Linux-x86_64-musl
            os: ubuntu-latest
            target: x86_64-unknown-linux-musl

          - os_name: Linux-aarch64
            os: ubuntu-latest
            target: aarch64-unknown-linux-gnu

          - os_name: Linux-aarch64-musl
            os: ubuntu-latest
            target: aarch64-unknown-linux-musl

          # Windows platforms
          - os_name: Windows-x86_64
            os: windows-latest
            target: x86_64-pc-windows-msvc

          - os_name: Windows-aarch64
            os: windows-latest
            target: aarch64-pc-windows-msvc

          # macOS platforms
          - os_name: macOS-x86_64
            os: macos-latest
            target: x86_64-apple-darwin

          - os_name: macOS-aarch64
            os: macos-latest
            target: aarch64-apple-darwin

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.get-tag.outputs.tag_name }}

      # Install cross-compilation dependencies for ARM64 targets
      - name: Install cross-compilation dependencies
        if: contains(matrix.platform.target, 'aarch64') && matrix.platform.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      # Install musl tools for musl targets
      - name: Install musl tools
        if: contains(matrix.platform.target, 'musl') && matrix.platform.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools

      - name: Build executable
        uses: houseabsolute/actions-rust-cross@v1
        with:
          command: build
          target: ${{ matrix.platform.target }}
          args: "--release --bin vx"
          strip: true

      - name: Set archive name
        id: archive
        shell: bash
        run: |
          # Use simple format: vx-{target}.{ext} (without version in filename)
          # Version is already in the release tag, no need to duplicate
          if [[ "${{ matrix.platform.os }}" == "windows-latest" ]]; then
            echo "name=vx-${{ matrix.platform.target }}.zip" >> $GITHUB_OUTPUT
            echo "ext=zip" >> $GITHUB_OUTPUT
          else
            echo "name=vx-${{ matrix.platform.target }}.tar.gz" >> $GITHUB_OUTPUT
            echo "ext=tar.gz" >> $GITHUB_OUTPUT
          fi

      - name: Create archive (Unix)
        if: matrix.platform.os != 'windows-latest'
        run: |
          cd target/${{ matrix.platform.target }}/release
          tar -czvf ../../../${{ steps.archive.outputs.name }} vx
          cd ../../..
          sha256sum ${{ steps.archive.outputs.name }} > ${{ steps.archive.outputs.name }}.sha256

      - name: Create archive (Windows)
        if: matrix.platform.os == 'windows-latest'
        shell: pwsh
        run: |
          cd target/${{ matrix.platform.target }}/release
          Compress-Archive -Path vx.exe -DestinationPath ../../../${{ steps.archive.outputs.name }}
          cd ../../..
          $hash = (Get-FileHash ${{ steps.archive.outputs.name }} -Algorithm SHA256).Hash.ToLower()
          "$hash  ${{ steps.archive.outputs.name }}" | Out-File -Encoding ASCII ${{ steps.archive.outputs.name }}.sha256

      - name: Upload artifacts to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.get-tag.outputs.tag_name }}
          files: |
            ${{ steps.archive.outputs.name }}
            ${{ steps.archive.outputs.name }}.sha256
          fail_on_unmatched_files: true

  # Create GitHub Release with all artifacts
  github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [get-tag, build-binaries]
    if: needs.build-binaries.result == 'success'
    permissions:
      contents: write
      actions: read

    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ needs.get-tag.outputs.tag_name }}
          fetch-depth: 0

      - name: Extract changelog for version
        id: changelog
        run: |
          VERSION="${{ needs.get-tag.outputs.version }}"
          echo "Extracting changelog for version: $VERSION"

          # Extract the changelog section for this version
          # Match from "## [VERSION]" or "## VERSION" until the next "## " or end of file
          CHANGELOG=$(awk -v ver="$VERSION" '
            BEGIN { found=0; output="" }
            /^## \[?[0-9]+\.[0-9]+\.[0-9]+\]?/ {
              if (found) exit
              if (index($0, ver) > 0) { found=1; next }
            }
            found { output = output $0 "\n" }
            END { print output }
          ' CHANGELOG.md)

          # If no changelog found, use a default message
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details."
          fi

          # Write to file to avoid escaping issues
          echo "$CHANGELOG" > /tmp/changelog.md
          echo "changelog_file=/tmp/changelog.md" >> $GITHUB_OUTPUT

      - name: Update GitHub Release
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ needs.get-tag.outputs.tag_name }}
          name: ${{ needs.get-tag.outputs.tag_name }}
          bodyFile: ${{ steps.changelog.outputs.changelog_file }}
          draft: false
          prerelease: false
          allowUpdates: true
          skipIfReleaseExists: false
          updateOnlyUnreleased: false
          makeLatest: true

      - name: Append installation instructions
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ needs.get-tag.outputs.tag_name }}
          name: ${{ needs.get-tag.outputs.tag_name }}
          body: |

            ---

            ### Installation

            #### Quick Install (Recommended)

            **Linux/macOS:**
            ```bash
            curl -fsSL https://raw.githubusercontent.com/loonghao/vx/main/install.sh | bash
            ```

            **Windows (PowerShell):**
            ```powershell
            irm https://raw.githubusercontent.com/loonghao/vx/main/install.ps1 | iex
            ```

            #### Manual Download

            Download the appropriate binary for your platform from the assets below.
          draft: false
          prerelease: false
          allowUpdates: true
          omitBodyDuringUpdate: false
          appendBody: true
          makeLatest: true

  # Update Homebrew formula
  update-homebrew:
    name: Update Homebrew Formula
    runs-on: ubuntu-latest
    needs: [get-tag, github-release]
    if: needs.github-release.result == 'success'
    steps:
      - name: Trigger Homebrew formula update
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: loonghao/homebrew-vx
          event-type: update-formula
          client-payload: '{"version": "${{ needs.get-tag.outputs.version }}"}'

  # Publish to crates.io
  publish-crates:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    needs: [get-tag, github-release]
    if: |
      needs.github-release.result == 'success' &&
      (github.event_name != 'workflow_dispatch' || inputs.skip-crates-publish != true)
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ needs.get-tag.outputs.tag_name }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Publish to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          if [ -z "$CARGO_REGISTRY_TOKEN" ]; then
            echo "CARGO_REGISTRY_TOKEN not set, skipping crates.io publishing"
            exit 0
          fi
          # Publish packages in dependency order
          # Note: Some packages may already be published, so we use --no-fail-fast
          cargo publish -p vx-paths --allow-dirty || true
          cargo publish -p vx-config --allow-dirty || true
          cargo publish -p vx-version --allow-dirty || true
          cargo publish -p vx-plugin --allow-dirty || true
          cargo publish -p vx-installer --allow-dirty || true
          cargo publish -p vx-dependency --allow-dirty || true
          cargo publish -p vx-tool-standard --allow-dirty || true
          cargo publish -p vx-sdk --allow-dirty || true
          cargo publish -p vx-core --allow-dirty || true
          cargo publish -p vx --allow-dirty || true
