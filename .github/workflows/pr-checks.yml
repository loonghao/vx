name: PR Checks

# Fast PR validation workflow - runs on every PR
# Uses vx itself to manage the development environment (dogfooding)

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

# Cancel in-progress runs for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  CARGO_HTTP_TIMEOUT: '600'
  CARGO_NET_RETRY: '10'
  CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse

jobs:
  # ============================================================================
  # Stage 1: Build vx binary for all platforms
  # ============================================================================
  build-vx:
    name: Build vx (${{ matrix.platform.name }})
    runs-on: ${{ matrix.platform.os }}
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        platform:
          - name: Linux
            os: ubuntu-latest
            artifact: vx-linux
            binary: vx
          - name: Windows
            os: windows-latest
            artifact: vx-windows
            binary: vx.exe
          - name: macOS
            os: macos-latest
            artifact: vx-macos
            binary: vx

    steps:
      - uses: actions/checkout@v6

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-build-${{ hashFiles('Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-build-

      - name: Build vx release binary
        run: cargo build --release

      - name: Verify binary
        shell: bash
        run: |
          ./target/release/${{ matrix.platform.binary }} --version
          ./target/release/${{ matrix.platform.binary }} --help

      - name: Upload vx binary
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.platform.artifact }}
          path: target/release/${{ matrix.platform.binary }}
          retention-days: 1

  # ============================================================================
  # Stage 2: Quick checks using vx (formatting, cargo check)
  # ============================================================================
  quick-checks:
    name: Quick Checks (via vx)
    runs-on: ubuntu-latest
    needs: build-vx
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v6

      - name: Download vx binary
        uses: actions/download-artifact@v7
        with:
          name: vx-linux
          path: ./bin

      - name: Setup vx
        run: |
          chmod +x ./bin/vx
          echo "${{ github.workspace }}/bin" >> $GITHUB_PATH
          ./bin/vx --version

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Cache Rust
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-quick-${{ hashFiles('Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-quick-

      - name: Check Rust formatting (via vx)
        run: vx run fmt-check

      - name: Cargo check (via vx)
        run: vx run check

  # ============================================================================
  # Stage 3: Clippy lints using vx
  # ============================================================================
  clippy:
    name: Clippy Lints (via vx)
    runs-on: ubuntu-latest
    needs: build-vx
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v6

      - name: Download vx binary
        uses: actions/download-artifact@v7
        with:
          name: vx-linux
          path: ./bin

      - name: Setup vx
        run: |
          chmod +x ./bin/vx
          echo "${{ github.workspace }}/bin" >> $GITHUB_PATH

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Cache Rust
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-clippy-${{ hashFiles('Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-clippy-

      - name: Run Clippy (via vx)
        run: vx run clippy

  # ============================================================================
  # Stage 4: Documentation check
  # ============================================================================
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    needs: build-vx
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v6

      - name: Download vx binary
        uses: actions/download-artifact@v7
        with:
          name: vx-linux
          path: ./bin

      - name: Setup vx
        run: |
          chmod +x ./bin/vx
          echo "${{ github.workspace }}/bin" >> $GITHUB_PATH

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-docs-${{ hashFiles('Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-docs-

      - name: Check documentation
        run: cargo doc --all-features --no-deps --document-private-items
        env:
          RUSTDOCFLAGS: "-D warnings"

  # ============================================================================
  # Stage 5: Unit tests using vx on multiple platforms
  # ============================================================================
  unit-test:
    name: Unit Test (${{ matrix.platform.name }}) via vx
    runs-on: ${{ matrix.platform.os }}
    needs: [build-vx, quick-checks]
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        platform:
          - name: Linux
            os: ubuntu-latest
            artifact: vx-linux
            binary: vx
          - name: Windows
            os: windows-latest
            artifact: vx-windows
            binary: vx.exe
          - name: macOS
            os: macos-latest
            artifact: vx-macos
            binary: vx

    steps:
      - uses: actions/checkout@v6

      - name: Download vx binary
        uses: actions/download-artifact@v7
        with:
          name: ${{ matrix.platform.artifact }}
          path: ./bin

      - name: Setup vx
        shell: bash
        run: |
          chmod +x ./bin/${{ matrix.platform.binary }} 2>/dev/null || true
          echo "${{ github.workspace }}/bin" >> $GITHUB_PATH

      - name: Verify vx works
        shell: bash
        run: |
          ./bin/${{ matrix.platform.binary }} --version
          ./bin/${{ matrix.platform.binary }} list

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-test-${{ hashFiles('Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-test-

      - name: Run unit tests (via vx)
        shell: bash
        run: vx run test

  # ============================================================================
  # Stage 6: E2E tests using vx
  # ============================================================================
  e2e-test:
    name: E2E Test (${{ matrix.platform.name }}) via vx
    runs-on: ${{ matrix.platform.os }}
    needs: [build-vx, unit-test]
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        platform:
          - name: Linux
            os: ubuntu-latest
            artifact: vx-linux
            binary: vx
          - name: Windows
            os: windows-latest
            artifact: vx-windows
            binary: vx.exe
          - name: macOS
            os: macos-latest
            artifact: vx-macos
            binary: vx

    steps:
      - uses: actions/checkout@v6

      - name: Download vx binary
        uses: actions/download-artifact@v7
        with:
          name: ${{ matrix.platform.artifact }}
          path: ./bin

      - name: Setup vx
        shell: bash
        run: |
          chmod +x ./bin/${{ matrix.platform.binary }} 2>/dev/null || true
          echo "${{ github.workspace }}/bin" >> $GITHUB_PATH

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-e2e-${{ hashFiles('Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-e2e-

      - name: Run E2E tests
        shell: bash
        run: cargo test --workspace --all-features --test '*'
        env:
          VX_BINARY: ${{ github.workspace }}/bin/${{ matrix.platform.binary }}

  # ============================================================================
  # Stage 7: Dogfood test - use vx to run real tools
  # ============================================================================
  dogfood:
    name: Dogfood (${{ matrix.platform.name }})
    runs-on: ${{ matrix.platform.os }}
    needs: build-vx
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        platform:
          - name: Linux
            os: ubuntu-latest
            artifact: vx-linux
            binary: vx
          - name: Windows
            os: windows-latest
            artifact: vx-windows
            binary: vx.exe
          - name: macOS
            os: macos-latest
            artifact: vx-macos
            binary: vx

    steps:
      - uses: actions/checkout@v6

      - name: Download vx binary
        uses: actions/download-artifact@v7
        with:
          name: ${{ matrix.platform.artifact }}
          path: ./bin

      - name: Setup vx
        shell: bash
        run: |
          chmod +x ./bin/${{ matrix.platform.binary }} 2>/dev/null || true
          echo "${{ github.workspace }}/bin" >> $GITHUB_PATH

      - name: Cache vx tools
        uses: actions/cache@v5
        with:
          path: ~/.vx
          key: ${{ runner.os }}-vx-dogfood-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-vx-dogfood-

      - name: Test vx with Node.js
        shell: bash
        run: |
          echo "=== Testing Node.js via vx ==="
          vx node --version
          vx node -e "console.log('Hello from Node.js via vx!')"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Test vx with Go
        shell: bash
        run: |
          echo "=== Testing Go via vx ==="
          vx go version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Test vx with UV
        shell: bash
        run: |
          echo "=== Testing UV via vx ==="
          vx uv --version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Show vx stats
        shell: bash
        run: |
          vx stats
          vx list --status

  # ============================================================================
  # Stage 8: Security audit
  # ============================================================================
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v6

      - name: Run security audit
        uses: rustsec/audit-check@v2.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # Stage 9: mdBook documentation build
  # ============================================================================
  mdbook:
    name: mdBook Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v6

      - name: Setup mdBook
        uses: peaceiris/actions-mdbook@v2
        with:
          mdbook-version: '0.4.40'

      - name: Build documentation
        run: mdbook build book

  # ============================================================================
  # PR Ready Gate
  # ============================================================================
  pr-ready:
    name: PR Ready
    runs-on: ubuntu-latest
    needs: [build-vx, quick-checks, clippy, docs, unit-test, e2e-test, dogfood, security, mdbook]
    if: always()
    steps:
      - name: Check results
        run: |
          echo "## PR Check Results" >> $GITHUB_STEP_SUMMARY

          # Define required jobs
          declare -A jobs=(
            ["build-vx"]="${{ needs.build-vx.result }}"
            ["quick-checks"]="${{ needs.quick-checks.result }}"
            ["clippy"]="${{ needs.clippy.result }}"
            ["docs"]="${{ needs.docs.result }}"
            ["unit-test"]="${{ needs.unit-test.result }}"
            ["e2e-test"]="${{ needs.e2e-test.result }}"
            ["dogfood"]="${{ needs.dogfood.result }}"
            ["security"]="${{ needs.security.result }}"
            ["mdbook"]="${{ needs.mdbook.result }}"
          )

          failed=0
          for job in "${!jobs[@]}"; do
            result="${jobs[$job]}"
            if [[ "$result" == "success" ]]; then
              echo "- ✅ $job" >> $GITHUB_STEP_SUMMARY
            elif [[ "$result" == "skipped" ]]; then
              echo "- ⏭️ $job (skipped)" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ❌ $job ($result)" >> $GITHUB_STEP_SUMMARY
              # dogfood failures are warnings, not blockers
              if [[ "$job" != "dogfood" ]]; then
                failed=1
              fi
            fi
          done

          if [[ $failed -eq 1 ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "❌ **PR is not ready for merge**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **PR is ready for merge!**" >> $GITHUB_STEP_SUMMARY
