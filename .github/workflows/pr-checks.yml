name: PR Checks

# Fast PR validation workflow - runs on every PR
# Optimized for quick feedback on code quality

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

# Cancel in-progress runs for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  CARGO_HTTP_TIMEOUT: '600'
  CARGO_NET_RETRY: '10'
  CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse

jobs:
  # Fast checks that run first (< 3 min)
  quick-checks:
    name: Quick Checks
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v6

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache Rust
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-quick-${{ hashFiles('Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-quick-

      - name: Check Rust formatting
        run: cargo fmt --all -- --check

      - name: Cargo check (fast compile check)
        run: cargo check --workspace --all-features

  # Clippy runs in parallel with quick-checks
  clippy:
    name: Clippy Lints
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v6

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Cache Rust
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-clippy-${{ hashFiles('Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-clippy-

      - name: Run Clippy
        run: cargo clippy --workspace --all-targets --all-features -- -D warnings

  # Documentation check
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v6

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-docs-${{ hashFiles('Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-docs-

      - name: Check documentation
        run: cargo doc --all-features --no-deps --document-private-items
        env:
          RUSTDOCFLAGS: "-D warnings"

  # Build binaries and upload as artifacts
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    needs: [quick-checks]
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            artifact: vx-linux
            binary: vx
          - os: windows-latest
            artifact: vx-windows
            binary: vx.exe
          - os: macos-latest
            artifact: vx-macos
            binary: vx
    steps:
      - uses: actions/checkout@v6

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-build-${{ hashFiles('Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-build-

      - name: Build release
        run: cargo build --release

      - name: Test CLI (--help)
        shell: bash
        run: |
          ./target/release/${{ matrix.binary }} --help
          ./target/release/${{ matrix.binary }} --version

      - name: Upload binary artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.artifact }}
          path: target/release/${{ matrix.binary }}
          retention-days: 1

  # Unit tests (no binary needed)
  unit-test:
    name: Unit Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    needs: [quick-checks]
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - uses: actions/checkout@v6

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-test-${{ hashFiles('Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-test-

      - name: Run unit tests
        run: cargo test --workspace --all-features --lib

  # E2E tests (download binary artifact)
  e2e-test:
    name: E2E Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    needs: [build]
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            artifact: vx-linux
            binary: vx
          - os: windows-latest
            artifact: vx-windows
            binary: vx.exe
          - os: macos-latest
            artifact: vx-macos
            binary: vx
    steps:
      - uses: actions/checkout@v6

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-e2e-${{ hashFiles('Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-e2e-

      - name: Download binary artifact
        uses: actions/download-artifact@v7
        with:
          name: ${{ matrix.artifact }}
          path: ./bin

      - name: Make binary executable
        if: runner.os != 'Windows'
        run: chmod +x ./bin/${{ matrix.binary }}

      - name: Run E2E tests
        shell: bash
        run: cargo test --workspace --all-features --test '*'
        env:
          VX_BINARY: ${{ github.workspace }}/bin/${{ matrix.binary }}

  # Security audit
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v6

      - name: Run security audit
        uses: rustsec/audit-check@v2.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  # Final gate - all critical checks must pass
  pr-ready:
    name: PR Ready
    runs-on: ubuntu-latest
    needs: [quick-checks, clippy, docs, unit-test, e2e-test, build, security]
    if: always()
    steps:
      - name: Check results
        run: |
          echo "## PR Check Results" >> $GITHUB_STEP_SUMMARY

          # Define required jobs
          declare -A jobs=(
            ["quick-checks"]="${{ needs.quick-checks.result }}"
            ["clippy"]="${{ needs.clippy.result }}"
            ["docs"]="${{ needs.docs.result }}"
            ["unit-test"]="${{ needs.unit-test.result }}"
            ["e2e-test"]="${{ needs.e2e-test.result }}"
            ["build"]="${{ needs.build.result }}"
            ["security"]="${{ needs.security.result }}"
          )

          failed=0
          for job in "${!jobs[@]}"; do
            result="${jobs[$job]}"
            if [[ "$result" == "success" ]]; then
              echo "- ✅ $job" >> $GITHUB_STEP_SUMMARY
            elif [[ "$result" == "skipped" ]]; then
              echo "- ⏭️ $job (skipped)" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ❌ $job ($result)" >> $GITHUB_STEP_SUMMARY
              failed=1
            fi
          done

          if [[ $failed -eq 1 ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "❌ **PR is not ready for merge**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **PR is ready for merge!**" >> $GITHUB_STEP_SUMMARY
