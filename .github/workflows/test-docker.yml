name: Test Docker Images

# Test Docker image builds to ensure they work correctly
# This workflow validates both the base and tools images
#
# We use Debian-based images with glibc for maximum compatibility.
# This ensures all tools installed by vx work correctly.

on:
  push:
    branches: [main]
    paths:
      - "pkg/docker/**"
      - "Dockerfile"
      - ".github/workflows/test-docker.yml"
      - "crates/**"
      - "Cargo.toml"
      - "Cargo.lock"
  pull_request:
    branches: [main]
    paths:
      - "pkg/docker/**"
      - "Dockerfile"
      - ".github/workflows/test-docker.yml"
      - "crates/**"
      - "Cargo.toml"
      - "Cargo.lock"
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  test-dockerfile-syntax:
    name: Validate Dockerfile syntax
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - uses: actions/checkout@v6

      - name: Download built binary
        uses: actions/download-artifact@v6
        with:
          name: vx-linux
          path: ${{ runner.temp }}

      - name: Setup vx from source build
        run: |
          chmod +x "$RUNNER_TEMP/vx"
          mkdir -p "$HOME/.local/bin"
          cp "$RUNNER_TEMP/vx" "$HOME/.local/bin/vx"
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          echo "$HOME/.vx/bin" >> $GITHUB_PATH
          "$HOME/.local/bin/vx" --version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Lint Dockerfile.prebuilt
        run: vx hadolint pkg/docker/Dockerfile.prebuilt --ignore DL3008

      - name: Lint Dockerfile.tools
        run: vx hadolint pkg/docker/Dockerfile.tools --ignore DL3008

  # ============================================================================
  # Build vx from current source code
  # This ensures Docker tests use the exact code being tested, not a release
  # ============================================================================
  build:
    name: Build vx binary
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-docker-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-docker-

      - name: Build vx
        run: cargo build --release

      - name: Verify binary
        run: |
          ./target/release/vx --version
          file ./target/release/vx

      - name: Upload binary
        uses: actions/upload-artifact@v6
        with:
          name: vx-linux
          path: target/release/vx
          retention-days: 1

  test-build-base-image:
    name: Test base image build
    runs-on: ubuntu-latest
    needs: [test-dockerfile-syntax, build]
    steps:
      - uses: actions/checkout@v6

      - name: Download built binary
        uses: actions/download-artifact@v6
        with:
          name: vx-linux
          path: .

      - name: Prepare binary
        run: |
          chmod +x vx
          ./vx --version

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build base image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: pkg/docker/Dockerfile.prebuilt
          platforms: linux/amd64
          push: false
          load: true
          tags: vx:test-base

      - name: Test base image
        run: |
          echo "Testing base image..."
          docker run --rm vx:test-base --version
          docker run --rm vx:test-base --help
          docker run --rm vx:test-base list

  test-build-tools-image:
    name: Test tools image build
    runs-on: ubuntu-latest
    needs: [test-dockerfile-syntax, build]
    steps:
      - uses: actions/checkout@v6

      - name: Download built binary
        uses: actions/download-artifact@v6
        with:
          name: vx-linux
          path: .

      - name: Prepare binary
        run: |
          chmod +x vx
          ./vx --version

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build tools image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: pkg/docker/Dockerfile.tools
          platforms: linux/amd64
          push: false
          load: true
          tags: vx:test-tools

      - name: Test tools image - vx commands
        run: |
          echo "Testing vx in tools image..."
          docker run --rm vx:test-tools --version
          docker run --rm vx:test-tools list --status

      - name: Test tools image - pre-installed tools
        run: |
          echo "Testing pre-installed tools..."

          # Test uv
          echo "Testing uv..."
          docker run --rm --entrypoint /bin/bash vx:test-tools -c "vx uv --version"

          # Test ruff via uvx
          echo "Testing ruff via uvx..."
          docker run --rm --entrypoint /bin/bash vx:test-tools -c "vx uvx ruff --version"

          # Test node
          echo "Testing node..."
          docker run --rm --entrypoint /bin/bash vx:test-tools -c "vx node --version"

          # Test npm
          echo "Testing npm..."
          docker run --rm --entrypoint /bin/bash vx:test-tools -c "vx npm --version"

      - name: Verify tools are cached in image
        run: |
          echo "Verifying tools are pre-cached..."
          docker run --rm --entrypoint /bin/bash vx:test-tools -c "ls -la ~/.vx/store/ 2>/dev/null || ls -la ~/.vx/ || echo 'Checking vx directories...'"

  test-tools-image-in-workflow:
    name: Test tools image in real workflow
    runs-on: ubuntu-latest
    needs: [build]
    container:
      # Use Ubuntu 24.04 for testing to match the actual tools image (glibc 2.39)
      image: ubuntu:24.04
    steps:
      - name: Install dependencies
        run: apt-get update && apt-get install -y --no-install-recommends ca-certificates

      - name: Download built binary
        uses: actions/download-artifact@v6
        with:
          name: vx-linux
          path: /usr/local/bin

      - name: Prepare binary
        run: chmod +x /usr/local/bin/vx

      - name: Verify vx works in container
        run: |
          vx --version
          vx list

      - name: Test Python workflow with uv
        run: |
          # This demonstrates the typical workflow users would run
          vx uv --version
          vx uvx ruff --version
          echo "Python tooling works!"

      - name: Test Node.js workflow
        run: |
          # Install Node.js LTS v22 for stability (avoid latest/unstable versions)
          vx install node@22
          vx node --version
          vx npm --version
          echo "Node.js tooling works!"
