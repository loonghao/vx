# End-to-End Tests Workflow
# Runs E2E tests on multiple platforms to verify CLI functionality
# Including real tool installation and execution tests

name: E2E Tests

on:
  push:
    branches: [main]
    paths:
      - 'crates/**'
      - 'src/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - '.github/workflows/e2e-tests.yml'
  pull_request:
    branches: [main]
    paths:
      - 'crates/**'
      - 'src/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - '.github/workflows/e2e-tests.yml'
  workflow_dispatch:
    inputs:
      run_real_tests:
        description: 'Run real tool tests (requires network)'
        type: boolean
        default: true
      tools_to_test:
        description: 'Tools to test (comma-separated, e.g., uv,node,go)'
        type: string
        default: 'uv,node,go,bun'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ============================================================================
  # Stage 1: Quick smoke test for basic CLI functionality
  # ============================================================================
  smoke-test:
    name: Smoke Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-action@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-smoke-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-smoke-
            ${{ runner.os }}-cargo-

      - name: Build vx binary
        run: cargo build --release

      - name: Run smoke tests
        run: |
          echo "=== Testing vx --version ==="
          ./target/release/vx --version

          echo "=== Testing vx --help ==="
          ./target/release/vx --help

          echo "=== Testing vx list ==="
          ./target/release/vx list

          echo "=== Testing vx list --status ==="
          ./target/release/vx list --status

          echo "=== Testing vx stats ==="
          ./target/release/vx stats

          echo "=== Testing vx search ==="
          ./target/release/vx search
        shell: bash

  # ============================================================================
  # Stage 2: E2E tests without network (fast, reliable)
  # ============================================================================
  e2e-tests:
    name: E2E Tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: smoke-test
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-action@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-e2e-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-e2e-
            ${{ runner.os }}-cargo-

      - name: Build vx binary
        run: cargo build --release

      - name: Run E2E tests (offline)
        run: cargo test --package vx-cli --test e2e_tests -- --nocapture
        env:
          CARGO_TARGET_DIR: target

      - name: Run CLI integration tests
        run: cargo test --package vx-cli --test cli_integration_tests -- --nocapture

      - name: Run tool execution tests (offline)
        run: cargo test --package vx-cli --test tool_execution_tests -- --nocapture

      - name: Run tool E2E tests (offline)
        run: cargo test --package vx-cli --test tool_e2e_tests -- --nocapture

  # ============================================================================
  # Stage 3: Real tool tests with actual installation and execution
  # ============================================================================
  real-tool-tests:
    name: Real Tool Tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: e2e-tests
    if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.run_real_tests == 'true' }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-action@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-real-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-real-
            ${{ runner.os }}-cargo-

      - name: Cache vx tools
        uses: actions/cache@v4
        with:
          path: ~/.vx
          key: ${{ runner.os }}-vx-tools-v1-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-vx-tools-v1-

      - name: Build vx binary
        run: cargo build --release

      - name: Setup vx in PATH
        shell: bash
        run: |
          mkdir -p ~/.local/bin
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            cp ./target/release/vx.exe ~/.local/bin/vx.exe
          else
            cp ./target/release/vx ~/.local/bin/vx
            chmod +x ~/.local/bin/vx
          fi
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Run real tool tests (Rust test framework)
        run: cargo test --package vx-cli --test real_tool_tests -- --ignored --nocapture --test-threads=1
        env:
          CARGO_TARGET_DIR: target
        timeout-minutes: 30

  # ============================================================================
  # Stage 4: Individual tool tests (more detailed, can be run in parallel)
  # ============================================================================
  tool-specific-tests:
    name: ${{ matrix.tool }} Tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: e2e-tests
    if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.run_real_tests == 'true' }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        tool: [uv, node, go, bun]
        exclude:
          # Bun doesn't support Windows well
          - os: windows-latest
            tool: bun

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-action@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ matrix.tool }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-${{ matrix.tool }}-
            ${{ runner.os }}-cargo-

      - name: Cache vx tools
        uses: actions/cache@v4
        with:
          path: ~/.vx
          key: ${{ runner.os }}-vx-${{ matrix.tool }}-v1-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-vx-${{ matrix.tool }}-v1-

      - name: Build vx binary
        run: cargo build --release

      - name: Setup vx in PATH
        shell: bash
        run: |
          mkdir -p ~/.local/bin
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            cp ./target/release/vx.exe ~/.local/bin/vx.exe
          else
            cp ./target/release/vx ~/.local/bin/vx
            chmod +x ~/.local/bin/vx
          fi
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install ${{ matrix.tool }}
        shell: bash
        run: |
          echo "=== Installing ${{ matrix.tool }} via vx ==="
          vx install ${{ matrix.tool }}
          echo "=== Verifying installation ==="
          vx which ${{ matrix.tool }} || true

      - name: Test ${{ matrix.tool }} - Version
        shell: bash
        run: |
          case "${{ matrix.tool }}" in
            uv)
              vx uv --version
              ;;
            node)
              vx node --version
              vx npm --version
              ;;
            go)
              vx go version
              ;;
            bun)
              vx bun --version
              ;;
          esac

      - name: Test ${{ matrix.tool }} - Basic Operations
        shell: bash
        run: |
          mkdir -p /tmp/test-${{ matrix.tool }}
          cd /tmp/test-${{ matrix.tool }}

          case "${{ matrix.tool }}" in
            uv)
              echo "=== Testing UV venv ==="
              vx uv venv .venv
              ls -la .venv || dir .venv

              echo "=== Testing UVX ==="
              vx uvx ruff --version
              ;;

            node)
              echo "=== Testing Node.js inline execution ==="
              vx node -e "console.log('Hello from Node.js via vx!')"
              vx node -e "console.log(JSON.stringify({platform: process.platform, version: process.version}))"

              echo "=== Testing NPM init ==="
              vx npm init -y
              cat package.json

              echo "=== Testing NPX ==="
              vx npx -y cowsay "Hello from npx!" || true
              ;;

            go)
              echo "=== Testing Go inline execution ==="
              cat > main.go << 'EOF'
          package main
          import "fmt"
          func main() {
              fmt.Println("Hello from Go via vx!")
          }
          EOF
              vx go run main.go

              echo "=== Testing Go mod init ==="
              vx go mod init example.com/test
              cat go.mod

              echo "=== Testing Go build ==="
              vx go build -o app main.go
              ls -la app* || dir app*
              ;;

            bun)
              echo "=== Testing Bun inline execution ==="
              vx bun -e "console.log('Hello from Bun via vx!')"

              echo "=== Testing Bun TypeScript ==="
              cat > test.ts << 'EOF'
          const msg: string = "Hello TypeScript!";
          console.log(msg);
          EOF
              vx bun run test.ts
              ;;
          esac

      - name: Run ${{ matrix.tool }} specific tests
        run: cargo test --package vx-cli --test real_tool_tests ${{ matrix.tool }} -- --ignored --nocapture
        env:
          CARGO_TARGET_DIR: target
        timeout-minutes: 15
        continue-on-error: true

  # ============================================================================
  # Stage 5: Cross-tool integration tests
  # ============================================================================
  cross-tool-tests:
    name: Cross-Tool Integration (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: tool-specific-tests
    if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.run_real_tests == 'true' }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]  # Skip Windows for cross-tool tests

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-action@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-cross-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache vx tools
        uses: actions/cache@v4
        with:
          path: ~/.vx
          key: ${{ runner.os }}-vx-cross-v1-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-vx-cross-v1-

      - name: Build vx binary
        run: cargo build --release

      - name: Setup vx in PATH
        shell: bash
        run: |
          mkdir -p ~/.local/bin
          cp ./target/release/vx ~/.local/bin/vx
          chmod +x ~/.local/bin/vx
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install all tools
        shell: bash
        run: |
          echo "=== Installing UV ==="
          vx install uv

          echo "=== Installing Node.js ==="
          vx install node

          echo "=== Installing Go ==="
          vx install go

      - name: Multi-language project simulation
        shell: bash
        run: |
          mkdir -p /tmp/multi-lang-project
          cd /tmp/multi-lang-project

          echo "=== Creating Python backend ==="
          mkdir -p backend
          cd backend
          vx uv init --name backend || vx uv venv .venv
          cd ..

          echo "=== Creating Node.js frontend ==="
          mkdir -p frontend
          cd frontend
          vx npm init -y
          cd ..

          echo "=== Creating Go services ==="
          mkdir -p services
          cd services
          vx go mod init example.com/services
          cat > main.go << 'EOF'
          package main
          import "fmt"
          func main() { fmt.Println("Service ready!") }
          EOF
          vx go build -o service main.go
          cd ..

          echo "=== Project structure ==="
          find . -type f -name "*.json" -o -name "*.toml" -o -name "*.mod" -o -name "service" 2>/dev/null || true
          ls -laR

      - name: Run cross-tool tests
        run: cargo test --package vx-cli --test real_tool_tests cross_tool -- --ignored --nocapture
        env:
          CARGO_TARGET_DIR: target
        timeout-minutes: 15
        continue-on-error: true

      - name: Show final stats
        shell: bash
        run: |
          echo "=== VX Stats ==="
          vx stats

          echo "=== Installed Tools ==="
          vx list --status

          echo "=== VX Directory ==="
          ls -la ~/.vx || true
          ls -la ~/.vx/tools || true

  # ============================================================================
  # Summary job
  # ============================================================================
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [smoke-test, e2e-tests, real-tool-tests, tool-specific-tests, cross-tool-tests]
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "## E2E Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Smoke Test | ${{ needs.smoke-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Tests | ${{ needs.e2e-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Real Tool Tests | ${{ needs.real-tool-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tool-Specific Tests | ${{ needs.tool-specific-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Cross-Tool Tests | ${{ needs.cross-tool-tests.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Fail if critical tests failed
        if: ${{ needs.smoke-test.result == 'failure' || needs.e2e-tests.result == 'failure' }}
        run: |
          echo "Critical tests failed!"
          exit 1
