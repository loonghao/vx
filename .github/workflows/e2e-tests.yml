# End-to-End Tests Workflow
# Runs E2E tests on multiple platforms to verify CLI functionality
# Uses artifact sharing to avoid redundant builds

name: E2E Tests

on:
  push:
    branches: [main]
    paths:
      - 'crates/**'
      - 'src/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - '.github/workflows/e2e-tests.yml'
  pull_request:
    branches: [main]
    paths:
      - 'crates/**'
      - 'src/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - '.github/workflows/e2e-tests.yml'
  workflow_dispatch:
    inputs:
      run_real_tests:
        description: 'Run real tool tests (requires network)'
        type: boolean
        default: true

env:
  CARGO_TERM_COLOR: always

jobs:
  # ============================================================================
  # Stage 1: Build binary and run smoke tests
  # ============================================================================
  build-and-smoke:
    name: Build & Smoke (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            artifact: vx-linux
            binary: vx
          - os: windows-latest
            artifact: vx-windows
            binary: vx.exe
          - os: macos-latest
            artifact: vx-macos
            binary: vx

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-build-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-build-
            ${{ runner.os }}-cargo-

      - name: Build vx binary (release)
        run: cargo build --release

      - name: Run smoke tests
        shell: bash
        run: |
          echo "=== vx --version ==="
          ./target/release/${{ matrix.binary }} --version

          echo "=== vx --help ==="
          ./target/release/${{ matrix.binary }} --help

          echo "=== vx list ==="
          ./target/release/${{ matrix.binary }} list

          echo "=== vx list --status ==="
          ./target/release/${{ matrix.binary }} list --status

          echo "=== vx stats ==="
          ./target/release/${{ matrix.binary }} stats

      - name: Upload binary artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.artifact }}
          path: target/release/${{ matrix.binary }}
          retention-days: 1

  # ============================================================================
  # Stage 2: E2E tests using pre-built binary
  # ============================================================================
  e2e-tests:
    name: E2E Tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: build-and-smoke
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            artifact: vx-linux
            binary: vx
          - os: windows-latest
            artifact: vx-windows
            binary: vx.exe
          - os: macos-latest
            artifact: vx-macos
            binary: vx

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download vx binary
        uses: actions/download-artifact@v7
        with:
          name: ${{ matrix.artifact }}
          path: ./bin

      - name: Setup vx in PATH
        shell: bash
        run: |
          chmod +x ./bin/${{ matrix.binary }} 2>/dev/null || true
          echo "${{ github.workspace }}/bin" >> $GITHUB_PATH
          # Also copy to target/release for test compatibility
          mkdir -p target/release
          cp ./bin/${{ matrix.binary }} target/release/

      - name: Cache vx tools
        uses: actions/cache@v5
        with:
          path: ~/.vx
          key: ${{ runner.os }}-vx-e2e-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-vx-e2e-

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-e2e-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-e2e-
            ${{ runner.os }}-cargo-

      - name: Verify vx works
        shell: bash
        run: vx --version

      - name: Run E2E tests (via vx)
        shell: bash
        run: vx cargo test --package vx-cli --test e2e_tests -- --nocapture
        env:
          VX_BINARY: ${{ github.workspace }}/target/release/${{ matrix.binary }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run CLI integration tests (via vx)
        shell: bash
        run: vx cargo test --package vx-cli --test cli_integration_tests -- --nocapture
        env:
          VX_BINARY: ${{ github.workspace }}/target/release/${{ matrix.binary }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run tool execution tests (via vx)
        shell: bash
        run: vx cargo test --package vx-cli --test tool_execution_tests -- --nocapture
        env:
          VX_BINARY: ${{ github.workspace }}/target/release/${{ matrix.binary }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run tool E2E tests (via vx)
        shell: bash
        run: vx cargo test --package vx-cli --test tool_e2e_tests -- --nocapture
        env:
          VX_BINARY: ${{ github.workspace }}/target/release/${{ matrix.binary }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # Stage 3: Self-hosted vx tests (dogfooding)
  # Uses vx itself to run tools, testing our own product
  # ============================================================================
  vx-dogfood:
    name: vx Dogfood (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: e2e-tests
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            artifact: vx-linux
            binary: vx
          - os: windows-latest
            artifact: vx-windows
            binary: vx.exe
          - os: macos-latest
            artifact: vx-macos
            binary: vx

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download vx binary
        uses: actions/download-artifact@v7
        with:
          name: ${{ matrix.artifact }}
          path: ./bin

      - name: Setup vx in PATH
        shell: bash
        run: |
          chmod +x ./bin/${{ matrix.binary }} 2>/dev/null || true
          echo "${{ github.workspace }}/bin" >> $GITHUB_PATH

      - name: Cache vx tools
        uses: actions/cache@v5
        with:
          path: ~/.vx
          key: ${{ runner.os }}-vx-dogfood-v1-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-vx-dogfood-v1-

      - name: Test vx with uv (Python linting)
        shell: bash
        run: |
          echo "=== Using vx to run uvx ruff ==="
          ./bin/${{ matrix.binary }} uvx ruff --version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Test vx with node (if package.json exists)
        shell: bash
        run: |
          echo "=== Using vx to run node ==="
          ./bin/${{ matrix.binary }} node --version
          ./bin/${{ matrix.binary }} npm --version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Test vx with go
        shell: bash
        run: |
          echo "=== Using vx to run go ==="
          ./bin/${{ matrix.binary }} go version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Show vx stats
        shell: bash
        run: |
          ./bin/${{ matrix.binary }} stats
          ./bin/${{ matrix.binary }} list --status

  # ============================================================================
  # Stage 4: Real tool tests (requires network)
  # ============================================================================
  real-tool-tests:
    name: Real Tool Tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: e2e-tests
    if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.run_real_tests == 'true' }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            artifact: vx-linux
            binary: vx
          - os: windows-latest
            artifact: vx-windows
            binary: vx.exe
          - os: macos-latest
            artifact: vx-macos
            binary: vx

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download vx binary
        uses: actions/download-artifact@v7
        with:
          name: ${{ matrix.artifact }}
          path: ./bin

      - name: Setup vx in PATH
        shell: bash
        run: |
          chmod +x ./bin/${{ matrix.binary }} 2>/dev/null || true
          echo "${{ github.workspace }}/bin" >> $GITHUB_PATH
          mkdir -p target/release
          cp ./bin/${{ matrix.binary }} target/release/

      - name: Cache vx tools
        uses: actions/cache@v5
        with:
          path: ~/.vx
          key: ${{ runner.os }}-vx-real-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-vx-real-

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-real-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-real-
            ${{ runner.os }}-cargo-

      - name: Verify vx works
        shell: bash
        run: vx --version

      - name: Run real tool tests (via vx)
        shell: bash
        run: vx cargo test --package vx-cli --test real_tool_tests -- --ignored --nocapture --test-threads=1
        env:
          VX_BINARY: ${{ github.workspace }}/target/release/${{ matrix.binary }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        timeout-minutes: 30

  # ============================================================================
  # Stage 5: Tool-specific tests (parallel per tool)
  # ============================================================================
  tool-tests:
    name: ${{ matrix.tool }} (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: e2e-tests
    if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.run_real_tests == 'true' }}
    strategy:
      fail-fast: false
      matrix:
        tool: [uv, node, go, bun]
        include:
          - os: ubuntu-latest
            artifact: vx-linux
            binary: vx
            tool: uv
          - os: ubuntu-latest
            artifact: vx-linux
            binary: vx
            tool: node
          - os: ubuntu-latest
            artifact: vx-linux
            binary: vx
            tool: go
          - os: ubuntu-latest
            artifact: vx-linux
            binary: vx
            tool: bun
          - os: windows-latest
            artifact: vx-windows
            binary: vx.exe
            tool: uv
          - os: windows-latest
            artifact: vx-windows
            binary: vx.exe
            tool: node
          - os: windows-latest
            artifact: vx-windows
            binary: vx.exe
            tool: go
          # Skip bun on Windows (not well supported)
          - os: macos-latest
            artifact: vx-macos
            binary: vx
            tool: uv
          - os: macos-latest
            artifact: vx-macos
            binary: vx
            tool: node
          - os: macos-latest
            artifact: vx-macos
            binary: vx
            tool: go
          - os: macos-latest
            artifact: vx-macos
            binary: vx
            tool: bun

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Cache vx tools
        uses: actions/cache@v5
        with:
          path: ~/.vx
          key: ${{ runner.os }}-vx-${{ matrix.tool }}-v1-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-vx-${{ matrix.tool }}-v1-

      - name: Download vx binary
        uses: actions/download-artifact@v7
        with:
          name: ${{ matrix.artifact }}
          path: ./bin

      - name: Setup vx
        shell: bash
        run: |
          chmod +x ./bin/${{ matrix.binary }} 2>/dev/null || true
          echo "${{ github.workspace }}/bin" >> $GITHUB_PATH

      - name: Install ${{ matrix.tool }}
        shell: bash
        run: |
          echo "=== Installing ${{ matrix.tool }} ==="
          ./bin/${{ matrix.binary }} --debug install ${{ matrix.tool }}
          echo "=== Checking installation ==="
          echo "Store directory contents:"
          ls -la ~/.vx/store/ || echo "Store directory does not exist"
          echo "Tool directory contents:"
          ls -laR ~/.vx/store/${{ matrix.tool }}/ || echo "Tool directory does not exist"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Test ${{ matrix.tool }}
        shell: bash
        run: |
          # Use absolute path to avoid issues when changing directories
          VX="${{ github.workspace }}/bin/${{ matrix.binary }}"

          case "${{ matrix.tool }}" in
            uv)
              echo "=== UV version ==="
              $VX --debug uv --version

              echo "=== UV venv ==="
              mkdir -p /tmp/test-uv && cd /tmp/test-uv
              $VX --debug uv venv .venv
              ls -la .venv || dir .venv

              echo "=== UVX ruff ==="
              $VX --debug uvx ruff --version
              ;;

            node)
              echo "=== Node version ==="
              $VX --debug node --version
              $VX --debug npm --version

              echo "=== Node inline ==="
              $VX --debug node -e "console.log('Hello from Node.js!')"

              echo "=== NPM init ==="
              mkdir -p /tmp/test-node && cd /tmp/test-node
              $VX --debug npm init -y
              cat package.json
              ;;

            go)
              echo "=== Go version ==="
              $VX --debug go version

              echo "=== Go run ==="
              mkdir -p /tmp/test-go && cd /tmp/test-go
              cat > main.go << 'EOF'
          package main
          import "fmt"
          func main() { fmt.Println("Hello from Go!") }
          EOF
              $VX --debug go run main.go

              echo "=== Go mod init ==="
              $VX --debug go mod init example.com/test
              cat go.mod
              ;;

            bun)
              echo "=== Bun version ==="
              $VX --debug bun --version

              echo "=== Bun inline ==="
              $VX --debug bun -e "console.log('Hello from Bun!')"

              echo "=== Bun TypeScript ==="
              mkdir -p /tmp/test-bun && cd /tmp/test-bun
              echo 'const x: string = "TS works!"; console.log(x);' > test.ts
              $VX --debug bun run test.ts
              ;;
          esac

      - name: Show stats
        shell: bash
        run: |
          ${{ github.workspace }}/bin/${{ matrix.binary }} list --status

  # ============================================================================
  # Summary
  # ============================================================================
  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [build-and-smoke, e2e-tests, vx-dogfood, real-tool-tests, tool-tests]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build & Smoke | ${{ needs.build-and-smoke.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Tests | ${{ needs.e2e-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| vx Dogfood | ${{ needs.vx-dogfood.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Real Tool Tests | ${{ needs.real-tool-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tool Tests | ${{ needs.tool-tests.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Check critical tests
        if: ${{ needs.build-and-smoke.result == 'failure' || needs.e2e-tests.result == 'failure' || needs.vx-dogfood.result == 'failure' }}
        run: |
          echo "Critical tests failed!"
          exit 1
