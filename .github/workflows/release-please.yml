name: Release Please

# This workflow manages automated releases using release-please
# Creates release PRs based on conventional commits
# Creates tags when release PRs are merged, triggering GoReleaser

on:
  push:
    branches:
      - main  # Monitor main branch for conventional commits
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: write
  pull-requests: write
  issues: write
  repository-projects: write

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      upload_url: ${{ steps.release.outputs.upload_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Release Please
        id: release
        uses: googleapis/release-please-action@v4
        with:
          config-file: .release-please-config.json
          manifest-file: .release-please-manifest.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: false

      - name: Display Release Please outputs
        if: always()
        run: |
          echo "🔍 Release Please Results:"
          echo "Release created: ${{ steps.release.outputs.release_created }}"
          echo "Tag name: ${{ steps.release.outputs.tag_name }}"
          echo "Upload URL: ${{ steps.release.outputs.upload_url }}"
          echo "PR number: ${{ steps.release.outputs.pr }}"

          if [ "${{ steps.release.outputs.release_created }}" = "true" ]; then
            echo "🎉 Release was created successfully!"
            echo "📦 Tag: ${{ steps.release.outputs.tag_name }}"
          elif [ "${{ steps.release.outputs.pr }}" != "" ]; then
            echo "📝 Release PR was created or updated"
            echo "🔗 PR: ${{ steps.release.outputs.pr }}"
          else
            echo "ℹ️ No release or PR was created (no releasable changes)"
          fi
