name: CI

# Optimized CI workflow with crate-level change detection
# - Detects changes at crate granularity
# - Only builds and tests affected crates
# - Respects dependency relationships between crates

on:
  push:
    branches: [main, develop]
  pull_request:
  workflow_dispatch:
    inputs:
      force_full_ci:
        description: "Force full CI run (ignore path filters)"
        type: boolean
        default: false

permissions:
  contents: read
  actions: read
  security-events: write

# Cancel in-progress runs for the same branch/PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  CARGO_HTTP_TIMEOUT: "600"
  CARGO_NET_RETRY: "10"
  CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse

jobs:
  # ============================================================================
  # Stage 0: Detect changes at crate level
  # ============================================================================
  detect-changes:
    name: Detect Changes
    # Skip CI for release commits (e.g., "chore: release v0.7.6") to avoid
    # unnecessary full CI runs when Release Please merges a release PR.
    if: >-
      github.event_name != 'push' ||
      !startsWith(github.event.head_commit.message, 'chore: release')
    runs-on: ubuntu-latest
    outputs:
      # High-level flags
      rust: ${{ steps.filter.outputs.rust }}
      docs: ${{ steps.filter.outputs.docs }}
      ci: ${{ steps.filter.outputs.ci }}
      scripts: ${{ steps.filter.outputs.scripts }}

      # Crate-level changes
      core: ${{ steps.filter.outputs.core }}
      paths: ${{ steps.filter.outputs.paths }}
      runtime: ${{ steps.filter.outputs.runtime }}
      resolver: ${{ steps.filter.outputs.resolver }}
      installer: ${{ steps.filter.outputs.installer }}
      config: ${{ steps.filter.outputs.config }}
      env: ${{ steps.filter.outputs.env }}
      setup: ${{ steps.filter.outputs.setup }}
      migration: ${{ steps.filter.outputs.migration }}
      extension: ${{ steps.filter.outputs.extension }}
      args: ${{ steps.filter.outputs.args }}
      project_analyzer: ${{ steps.filter.outputs.project_analyzer }}
      console: ${{ steps.filter.outputs.console }}
      cli: ${{ steps.filter.outputs.cli }}
      providers: ${{ steps.filter.outputs.providers }}

      # Computed flags
      should_build: ${{ steps.decide.outputs.should_build }}
      should_test: ${{ steps.decide.outputs.should_test }}
      should_docs: ${{ steps.decide.outputs.should_docs }}
      is_main: ${{ steps.decide.outputs.is_main }}

      # Affected crates list (JSON)
      affected_crates: ${{ steps.compute-affected.outputs.affected_crates }}
      test_packages: ${{ steps.compute-affected.outputs.test_packages }}

    steps:
      - uses: actions/checkout@v6

      - name: Detect file changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            rust:
              - 'crates/**'
              - 'src/**'
              - 'Cargo.toml'
              - 'Cargo.lock'
              - 'tests/**'
              - 'examples/**'
              - 'clippy.toml'
              - 'rust-toolchain.toml'
              - '.config/hakari.toml'
            docs:
              - 'docs/**'
            ci:
              - '.github/workflows/**'
              - 'action.yml'
            scripts:
              - 'scripts/**'
              - 'install*.sh'
              - 'install*.ps1'

            # Core crates (foundation layer)
            core:
              - 'crates/vx-core/**'
            paths:
              - 'crates/vx-paths/**'

            # Infrastructure crates
            runtime:
              - 'crates/vx-runtime/**'
            resolver:
              - 'crates/vx-resolver/**'
            installer:
              - 'crates/vx-installer/**'
            config:
              - 'crates/vx-config/**'
            env:
              - 'crates/vx-env/**'
            setup:
              - 'crates/vx-setup/**'
            migration:
              - 'crates/vx-migration/**'
            extension:
              - 'crates/vx-extension/**'
            args:
              - 'crates/vx-args/**'
            project_analyzer:
              - 'crates/vx-project-analyzer/**'
            console:
              - 'crates/vx-console/**'

            # Application layer
            cli:
              - 'crates/vx-cli/**'
              - 'src/**'

            # All providers (grouped)
            providers:
              - 'crates/vx-providers/**'

      - name: Compute affected crates
        id: compute-affected
        shell: bash
        run: |
          # Initialize affected crates array
          AFFECTED=()
          TEST_PKGS=()

          FORCE_FULL="${{ github.event.inputs.force_full_ci || 'false' }}"
          CI_CHANGED="${{ steps.filter.outputs.ci }}"

          # If CI config changed or force full, test everything
          if [[ "$FORCE_FULL" == "true" || "$CI_CHANGED" == "true" ]]; then
            echo "Full CI triggered (force=$FORCE_FULL, ci_changed=$CI_CHANGED)"
            AFFECTED=("all")
            TEST_PKGS=("--workspace")
          else
            # Core layer - affects everything that depends on it
            if [[ "${{ steps.filter.outputs.core }}" == "true" ]]; then
              AFFECTED+=("vx-core" "vx-runtime" "vx-resolver" "vx-extension" "vx-project-analyzer" "vx-cli" "providers")
            fi

            if [[ "${{ steps.filter.outputs.paths }}" == "true" ]]; then
              AFFECTED+=("vx-paths" "vx-runtime" "vx-resolver" "vx-env" "vx-setup" "vx-migration" "vx-args" "vx-extension" "vx-project-analyzer" "vx-cli")
            fi

            # Infrastructure layer
            if [[ "${{ steps.filter.outputs.runtime }}" == "true" ]]; then
              AFFECTED+=("vx-runtime" "vx-resolver" "vx-extension" "vx-cli" "providers")
            fi

            if [[ "${{ steps.filter.outputs.resolver }}" == "true" ]]; then
              AFFECTED+=("vx-resolver" "vx-cli")
            fi

            if [[ "${{ steps.filter.outputs.installer }}" == "true" ]]; then
              AFFECTED+=("vx-installer" "vx-cli")
            fi

            if [[ "${{ steps.filter.outputs.config }}" == "true" ]]; then
              AFFECTED+=("vx-config" "vx-project-analyzer" "vx-cli")
            fi

            if [[ "${{ steps.filter.outputs.env }}" == "true" ]]; then
              AFFECTED+=("vx-env" "vx-cli")
            fi

            if [[ "${{ steps.filter.outputs.setup }}" == "true" ]]; then
              AFFECTED+=("vx-setup" "vx-cli")
            fi

            if [[ "${{ steps.filter.outputs.migration }}" == "true" ]]; then
              AFFECTED+=("vx-migration" "vx-cli")
            fi

            if [[ "${{ steps.filter.outputs.extension }}" == "true" ]]; then
              AFFECTED+=("vx-extension" "vx-cli")
            fi

            if [[ "${{ steps.filter.outputs.args }}" == "true" ]]; then
              AFFECTED+=("vx-args" "vx-extension" "vx-cli")
            fi

            if [[ "${{ steps.filter.outputs.project_analyzer }}" == "true" ]]; then
              AFFECTED+=("vx-project-analyzer" "vx-cli")
            fi

            if [[ "${{ steps.filter.outputs.console }}" == "true" ]]; then
              AFFECTED+=("vx-console" "vx-cli")
            fi

            if [[ "${{ steps.filter.outputs.cli }}" == "true" ]]; then
              AFFECTED+=("vx-cli")
            fi

            if [[ "${{ steps.filter.outputs.providers }}" == "true" ]]; then
              AFFECTED+=("providers" "vx-cli")
            fi

            # Remove duplicates and sort
            if [[ ${#AFFECTED[@]} -gt 0 ]]; then
              AFFECTED=($(printf '%s\n' "${AFFECTED[@]}" | sort -u))
            fi

            # Build test package arguments
            for crate in "${AFFECTED[@]}"; do
              case "$crate" in
                "all")
                  TEST_PKGS=("--workspace")
                  break
                  ;;
                "providers")
                  # Test all providers as a group
                  TEST_PKGS+=("-p" "vx-provider-*")
                  ;;
                *)
                  TEST_PKGS+=("-p" "$crate")
                  ;;
              esac
            done
          fi

          # Convert to JSON for output
          if [[ ${#AFFECTED[@]} -eq 0 ]]; then
            # If no specific crates detected but rust files changed, fallback to workspace test
            RUST_CHANGED="${{ steps.filter.outputs.rust }}"
            if [[ "$RUST_CHANGED" == "true" ]]; then
              echo "No specific crates detected but Rust changed - falling back to workspace test"
              echo "affected_crates=[\"all\"]" >> $GITHUB_OUTPUT
              echo "test_packages=--workspace" >> $GITHUB_OUTPUT
            else
              echo "affected_crates=[]" >> $GITHUB_OUTPUT
              echo "test_packages=" >> $GITHUB_OUTPUT
            fi
          else
            AFFECTED_JSON=$(printf '%s\n' "${AFFECTED[@]}" | jq -R . | jq -s -c .)
            echo "affected_crates=$AFFECTED_JSON" >> $GITHUB_OUTPUT
            echo "test_packages=${TEST_PKGS[*]}" >> $GITHUB_OUTPUT
          fi

          # Debug output
          echo "Affected crates: ${AFFECTED[*]}"
          echo "Test packages: ${TEST_PKGS[*]}"

      - name: Decide what to run
        id: decide
        shell: bash
        run: |
          FORCE_FULL="${{ github.event.inputs.force_full_ci || 'false' }}"

          # Check if this is main branch
          IS_MAIN="false"
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            IS_MAIN="true"
          fi
          echo "is_main=$IS_MAIN" >> $GITHUB_OUTPUT

          RUST_CHANGED="${{ steps.filter.outputs.rust }}"
          DOCS_CHANGED="${{ steps.filter.outputs.docs }}"
          CI_CHANGED="${{ steps.filter.outputs.ci }}"

          # Build if rust changed, CI changed, or forced
          if [[ "$RUST_CHANGED" == "true" || "$CI_CHANGED" == "true" || "$FORCE_FULL" == "true" ]]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "should_test=true" >> $GITHUB_OUTPUT
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
            echo "should_test=false" >> $GITHUB_OUTPUT
          fi

          # Docs if docs changed or forced
          if [[ "$DOCS_CHANGED" == "true" || "$FORCE_FULL" == "true" ]]; then
            echo "should_docs=true" >> $GITHUB_OUTPUT
          else
            echo "should_docs=false" >> $GITHUB_OUTPUT
          fi

          # Summary
          echo "## Change Detection Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### High-Level Changes" >> $GITHUB_STEP_SUMMARY
          echo "| Category | Changed |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Rust Code | $RUST_CHANGED |" >> $GITHUB_STEP_SUMMARY
          echo "| Documentation | $DOCS_CHANGED |" >> $GITHUB_STEP_SUMMARY
          echo "| CI Config | $CI_CHANGED |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Crate-Level Changes" >> $GITHUB_STEP_SUMMARY
          echo "| Crate | Changed |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| vx-core | ${{ steps.filter.outputs.core }} |" >> $GITHUB_STEP_SUMMARY
          echo "| vx-paths | ${{ steps.filter.outputs.paths }} |" >> $GITHUB_STEP_SUMMARY
          echo "| vx-runtime | ${{ steps.filter.outputs.runtime }} |" >> $GITHUB_STEP_SUMMARY
          echo "| vx-resolver | ${{ steps.filter.outputs.resolver }} |" >> $GITHUB_STEP_SUMMARY
          echo "| vx-installer | ${{ steps.filter.outputs.installer }} |" >> $GITHUB_STEP_SUMMARY
          echo "| vx-config | ${{ steps.filter.outputs.config }} |" >> $GITHUB_STEP_SUMMARY
          echo "| vx-env | ${{ steps.filter.outputs.env }} |" >> $GITHUB_STEP_SUMMARY
          echo "| vx-setup | ${{ steps.filter.outputs.setup }} |" >> $GITHUB_STEP_SUMMARY
          echo "| vx-migration | ${{ steps.filter.outputs.migration }} |" >> $GITHUB_STEP_SUMMARY
          echo "| vx-extension | ${{ steps.filter.outputs.extension }} |" >> $GITHUB_STEP_SUMMARY
          echo "| vx-args | ${{ steps.filter.outputs.args }} |" >> $GITHUB_STEP_SUMMARY
          echo "| vx-project-analyzer | ${{ steps.filter.outputs.project_analyzer }} |" >> $GITHUB_STEP_SUMMARY
          echo "| vx-console | ${{ steps.filter.outputs.console }} |" >> $GITHUB_STEP_SUMMARY
          echo "| vx-cli | ${{ steps.filter.outputs.cli }} |" >> $GITHUB_STEP_SUMMARY
          echo "| providers | ${{ steps.filter.outputs.providers }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Affected Crates" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.compute-affected.outputs.affected_crates }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test packages:** \`${{ steps.compute-affected.outputs.test_packages }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "**Is Main:** $IS_MAIN" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Stage 1: Build vx binary (only if rust/ci changed)
  # ============================================================================
  build-vx:
    name: Build vx (${{ matrix.platform.name }})
    runs-on: ${{ matrix.platform.os }}
    needs: detect-changes
    if: needs.detect-changes.outputs.should_build == 'true'
    timeout-minutes: 20
    env:
      RUSTC_WRAPPER: sccache
      SCCACHE_DIR: ${{ github.workspace }}/.cache/sccache

    strategy:
      fail-fast: false
      matrix:
        platform:
          - name: Linux-x86_64
            os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact: vx-linux-x64
            binary: vx
          - name: Windows-x86_64
            os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact: vx-windows-x64
            binary: vx.exe
          - name: macOS-x86_64
            os: macos-latest
            target: x86_64-apple-darwin
            artifact: vx-macos-x64
            binary: vx
          - name: macOS-ARM64
            os: macos-latest
            target: aarch64-apple-darwin
            artifact: vx-macos-arm64
            binary: vx

    steps:
      - uses: actions/checkout@v6

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform.target }}

      - name: Install sccache
        uses: taiki-e/install-action@v2
        with:
          tool: sccache

      - name: Cache sccache
        uses: actions/cache@v5
        with:
          path: ${{ github.workspace }}/.cache/sccache
          key: ${{ runner.os }}-sccache-${{ matrix.platform.target }}-${{ hashFiles('Cargo.lock') }}

          restore-keys: |
            ${{ runner.os }}-sccache-${{ matrix.platform.target }}-
            ${{ runner.os }}-sccache-

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: ${{ matrix.platform.target }}
          shared-key: build
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Build vx release binary
        run: cargo build --release --target ${{ matrix.platform.target }}

      - name: Verify binary
        shell: bash
        run: |
          ./target/${{ matrix.platform.target }}/release/${{ matrix.platform.binary }} --version
          ./target/${{ matrix.platform.target }}/release/${{ matrix.platform.binary }} --help

      - name: Upload vx binary
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.platform.artifact }}
          path: target/${{ matrix.platform.target }}/release/${{ matrix.platform.binary }}
          retention-days: 1

  # ============================================================================
  # Stage 2: Code quality checks (only if rust changed)
  # ============================================================================
  code-quality:
    name: Code Quality (via vx)
    runs-on: ubuntu-latest
    needs: [detect-changes, build-vx]
    if: needs.detect-changes.outputs.should_build == 'true'
    timeout-minutes: 15
    env:
      RUSTC_WRAPPER: sccache
      SCCACHE_DIR: ${{ github.workspace }}/.cache/sccache

    steps:
      - uses: actions/checkout@v6

      - name: Download vx binary
        uses: actions/download-artifact@v7
        with:
          name: vx-linux-x64
          path: ./bin

      - name: Setup vx
        shell: bash
        run: |
          chmod +x ./bin/vx
          echo "${{ github.workspace }}/bin" >> $GITHUB_PATH
          ./bin/vx --version

      - name: Cache vx tools
        uses: actions/cache@v5
        with:
          path: ~/.vx
          key: ${{ runner.os }}-vx-tools-quality-${{ hashFiles('vx.toml') }}
          restore-keys: |
            ${{ runner.os }}-vx-tools-quality-

      - name: Setup Rust (required for cargo commands)
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Install sccache
        uses: taiki-e/install-action@v2
        with:
          tool: sccache

      - name: Cache sccache
        uses: actions/cache@v5
        with:
          path: ${{ github.workspace }}/.cache/sccache
          key: ${{ runner.os }}-sccache-quality-${{ hashFiles('Cargo.lock') }}

          restore-keys: |
            ${{ runner.os }}-sccache-quality-
            ${{ runner.os }}-sccache-

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: quality
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Verify workspace-hack (cargo-hakari)
        run: |
          cargo install cargo-hakari --locked
          cargo hakari generate --diff
          cargo hakari manage-deps --dry-run

      - name: Check formatting (via vx)
        run: vx just format-check

      - name: Check for inline tests
        run: |
          vx just check-inline-tests || true
          # Note: Currently a warning only, will become error after migration

      - name: Run Clippy (via vx)
        run: vx just lint

      - name: Check documentation (via vx)
        run: vx just ci-docs

  # ============================================================================
  # Stage 3: Targeted tests (only test affected crates)
  # ============================================================================
  test-targeted:
    name: Test (${{ matrix.platform.name }}) - Targeted
    runs-on: ${{ matrix.platform.os }}
    needs: [detect-changes, build-vx]
    if: |
      needs.detect-changes.outputs.should_test == 'true' &&
      needs.detect-changes.outputs.test_packages != '' &&
      !contains(needs.detect-changes.outputs.test_packages, '--workspace')
    timeout-minutes: 25
    env:
      RUSTC_WRAPPER: sccache
      SCCACHE_DIR: ${{ github.workspace }}/.cache/sccache

    strategy:
      fail-fast: false
      matrix:
        platform:
          - name: Linux-x86_64
            os: ubuntu-latest
            artifact: vx-linux-x64
            binary: vx
          - name: Windows-x86_64
            os: windows-latest
            artifact: vx-windows-x64
            binary: vx.exe
          - name: macOS-x86_64
            os: macos-latest
            artifact: vx-macos-x64
            binary: vx

    steps:
      - uses: actions/checkout@v6

      - name: Download vx binary
        uses: actions/download-artifact@v7
        with:
          name: ${{ matrix.platform.artifact }}
          path: ./bin

      - name: Setup vx
        shell: bash
        run: |
          chmod +x ./bin/${{ matrix.platform.binary }} 2>/dev/null || true
          echo "${{ github.workspace }}/bin" >> $GITHUB_PATH

      - name: Verify vx works
        shell: bash
        run: |
          ./bin/${{ matrix.platform.binary }} --version
          ./bin/${{ matrix.platform.binary }} list

      - name: Cache vx tools
        uses: actions/cache@v5
        with:
          path: ~/.vx
          key: ${{ runner.os }}-vx-tools-test-${{ hashFiles('vx.toml') }}
          restore-keys: |
            ${{ runner.os }}-vx-tools-test-

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install sccache
        uses: taiki-e/install-action@v2
        with:
          tool: sccache

      - name: Cache sccache
        uses: actions/cache@v5
        with:
          path: ${{ github.workspace }}/.cache/sccache
          key: ${{ runner.os }}-sccache-test-${{ matrix.platform.name }}-${{ hashFiles('Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-sccache-test-${{ matrix.platform.name }}-
            ${{ runner.os }}-sccache-test-
            ${{ runner.os }}-sccache-

      - name: Add Rust to PATH (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $cargoPath = "$env:USERPROFILE\.cargo\bin"
          echo "$cargoPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "Added $cargoPath to PATH"

      - name: Verify cargo is available
        shell: bash
        run: |
          echo "Checking cargo..."
          which cargo || where cargo || echo "cargo location unknown"
          cargo --version

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: test
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Run targeted tests (via vx)
        shell: bash
        run: |
          echo "Testing affected crates: ${{ needs.detect-changes.outputs.affected_crates }}"
          echo "Test packages: ${{ needs.detect-changes.outputs.test_packages }}"

          # Run tests for affected packages only (delegated to vx for local/CI parity)
          vx just test-pkgs "${{ needs.detect-changes.outputs.test_packages }}"
        env:
          CARGO_TARGET_DIR: target
          VX_BINARY: ${{ github.workspace }}/bin/${{ matrix.platform.binary }}

  # ============================================================================
  # Stage 3b: Full workspace tests (when core changes or CI changes)
  # ============================================================================
  test-full:
    name: Test (${{ matrix.platform.name }}) - Full
    runs-on: ${{ matrix.platform.os }}
    needs: [detect-changes, build-vx]
    if: |
      needs.detect-changes.outputs.should_test == 'true' &&
      contains(needs.detect-changes.outputs.test_packages, '--workspace')
    timeout-minutes: 25
    env:
      RUSTC_WRAPPER: sccache
      SCCACHE_DIR: ${{ github.workspace }}/.cache/sccache

    strategy:
      fail-fast: false
      matrix:
        platform:
          - name: Linux-x86_64
            os: ubuntu-latest
            artifact: vx-linux-x64
            binary: vx
          - name: Windows-x86_64
            os: windows-latest
            artifact: vx-windows-x64
            binary: vx.exe
          - name: macOS-x86_64
            os: macos-latest
            artifact: vx-macos-x64
            binary: vx

    steps:
      - uses: actions/checkout@v6

      - name: Download vx binary
        uses: actions/download-artifact@v7
        with:
          name: ${{ matrix.platform.artifact }}
          path: ./bin

      - name: Setup vx
        shell: bash
        run: |
          chmod +x ./bin/${{ matrix.platform.binary }} 2>/dev/null || true
          echo "${{ github.workspace }}/bin" >> $GITHUB_PATH

      - name: Verify vx works
        shell: bash
        run: |
          ./bin/${{ matrix.platform.binary }} --version
          ./bin/${{ matrix.platform.binary }} list

      - name: Cache vx tools
        uses: actions/cache@v5
        with:
          path: ~/.vx
          key: ${{ runner.os }}-vx-tools-test-${{ hashFiles('vx.toml') }}
          restore-keys: |
            ${{ runner.os }}-vx-tools-test-

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install sccache
        uses: taiki-e/install-action@v2
        with:
          tool: sccache

      - name: Cache sccache
        uses: actions/cache@v5
        with:
          path: ${{ github.workspace }}/.cache/sccache
          key: ${{ runner.os }}-sccache-test-${{ matrix.platform.name }}-${{ hashFiles('Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-sccache-test-${{ matrix.platform.name }}-
            ${{ runner.os }}-sccache-test-
            ${{ runner.os }}-sccache-

      - name: Add Rust to PATH (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $cargoPath = "$env:USERPROFILE\.cargo\bin"
          echo "$cargoPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "Added $cargoPath to PATH"

      - name: Verify cargo is available
        shell: bash
        run: |
          echo "Checking cargo..."
          which cargo || where cargo || echo "cargo location unknown"
          cargo --version

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: test
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Run full workspace tests (via vx)
        shell: bash
        run: vx just test
        env:
          CARGO_TARGET_DIR: target
          VX_BINARY: ${{ github.workspace }}/bin/${{ matrix.platform.binary }}

  # ============================================================================
  # Stage 5: Cross-compilation (main branch only, if rust changed)
  # ============================================================================
  cross-build:
    name: Cross Build (${{ matrix.target }})
    runs-on: ubuntu-latest
    needs: [detect-changes, build-vx]
    if: |
      needs.detect-changes.outputs.should_build == 'true' &&
      needs.detect-changes.outputs.is_main == 'true'
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        target:
          - aarch64-unknown-linux-gnu
          - x86_64-unknown-linux-musl
          - aarch64-unknown-linux-musl

    steps:
      - uses: actions/checkout@v6

      - name: Download vx binary
        uses: actions/download-artifact@v7
        with:
          name: vx-linux-x64
          path: ./bin

      - name: Setup vx
        run: |
          chmod +x ./bin/vx
          echo "${{ github.workspace }}/bin" >> $GITHUB_PATH

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cross
        uses: taiki-e/install-action@v2
        with:
          tool: cross

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: ${{ matrix.target }}
          shared-key: cross
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Build with cross
        run: vx just cross-build ${{ matrix.target }}

  # ============================================================================
  # Stage 6: Security audit (only if rust changed)
  # ============================================================================
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.should_build == 'true'
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v6

      - name: Setup vx
        uses: ./
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-audit

      - name: Run security audit
        run: vx just security-audit-ci

  # ============================================================================
  # Stage 7: Code coverage (main branch only)
  # ============================================================================
  coverage:
    name: Code Coverage (via vx)
    runs-on: ubuntu-latest
    needs: [detect-changes, build-vx]
    if: |
      needs.detect-changes.outputs.should_build == 'true' &&
      needs.detect-changes.outputs.is_main == 'true'
    timeout-minutes: 20
    env:
      RUSTC_WRAPPER: sccache
      SCCACHE_DIR: ${{ github.workspace }}/.cache/sccache

    steps:
      - uses: actions/checkout@v6

      - name: Download vx binary
        uses: actions/download-artifact@v7
        with:
          name: vx-linux-x64
          path: ./bin

      - name: Setup vx
        run: |
          chmod +x ./bin/vx
          echo "${{ github.workspace }}/bin" >> $GITHUB_PATH

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install sccache
        uses: taiki-e/install-action@v2
        with:
          tool: sccache

      - name: Cache sccache
        uses: actions/cache@v5
        with:
          path: ${{ github.workspace }}/.cache/sccache
          key: ${{ runner.os }}-sccache-coverage-${{ hashFiles('Cargo.lock') }}

          restore-keys: |
            ${{ runner.os }}-sccache-coverage-
            ${{ runner.os }}-sccache-

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: coverage
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Generate coverage
        run: vx just coverage-ci

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: lcov.info
          fail_ci_if_error: false
          verbose: true
          flags: unittests
          name: codecov-umbrella

  # ============================================================================
  # Stage 9: Documentation build (only if docs changed)
  # ============================================================================
  docs-build:
    name: Documentation Build
    runs-on: ubuntu-latest
    needs: [detect-changes, build-vx]
    if: |
      needs.detect-changes.outputs.should_docs == 'true' &&
      needs.detect-changes.outputs.should_build == 'true'
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v6

      - name: Download vx binary
        uses: actions/download-artifact@v7
        with:
          name: vx-linux-x64
          path: ./bin

      - name: Setup vx
        run: |
          chmod +x ./bin/vx
          echo "${{ github.workspace }}/bin" >> $GITHUB_PATH

      - name: Install Node.js via vx
        run: vx install node

      - name: Install dependencies
        run: vx just docs-install

      - name: Build documentation
        run: vx just docs-build

  # Docs build without vx binary (when only docs changed)
  docs-build-standalone:
    name: Documentation Build (standalone)
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.should_docs == 'true' &&
      needs.detect-changes.outputs.should_build == 'false'
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: "npm"
          cache-dependency-path: docs/package-lock.json

      - name: Install dependencies
        working-directory: docs
        run: npm install

      - name: Build documentation
        working-directory: docs
        run: npm run build

  # ============================================================================
  # CI Success Gate
  # ============================================================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs:
      - detect-changes
      - build-vx
      - code-quality
      - test-targeted
      - test-full
      - cross-build
      - security-audit
      - coverage
      - docs-build
      - docs-build-standalone
    if: always()
    steps:
      - name: Check results
        shell: bash
        run: |
          echo "## CI Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          failed=0

          # Check each job result
          check_job() {
            local job_name="$1"
            local result="$2"
            if [[ "$result" == "success" ]]; then
              echo "- ✅ $job_name" >> $GITHUB_STEP_SUMMARY
            elif [[ "$result" == "skipped" ]]; then
              echo "- ⏭️ $job_name (skipped)" >> $GITHUB_STEP_SUMMARY
            elif [[ "$result" == "cancelled" ]]; then
              # Cancelled jobs are acceptable - usually due to concurrency group
              echo "- ⚠️ $job_name (cancelled)" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ❌ $job_name ($result)" >> $GITHUB_STEP_SUMMARY
              # Don't fail on skipped or cancelled jobs
              if [[ "$result" != "skipped" && "$result" != "cancelled" && "$result" != "" ]]; then
                failed=1
              fi
            fi
          }
          echo "### Core Jobs" >> $GITHUB_STEP_SUMMARY
          check_job "detect-changes" "${{ needs.detect-changes.result }}"

          check_job "build-vx" "${{ needs.build-vx.result }}"
          check_job "code-quality" "${{ needs.code-quality.result }}"
          check_job "test-targeted" "${{ needs.test-targeted.result }}"
          check_job "test-full" "${{ needs.test-full.result }}"
          check_job "security-audit" "${{ needs.security-audit.result }}"


          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Main Branch Only" >> $GITHUB_STEP_SUMMARY
          check_job "cross-build" "${{ needs.cross-build.result }}"
          check_job "coverage" "${{ needs.coverage.result }}"

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Documentation" >> $GITHUB_STEP_SUMMARY
          check_job "docs-build" "${{ needs.docs-build.result }}"
          check_job "docs-build-standalone" "${{ needs.docs-build-standalone.result }}"

          if [[ $failed -eq 1 ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "❌ **CI failed**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **All CI checks passed!**" >> $GITHUB_STEP_SUMMARY
